---
title: "Pipeline Performance Figure Generation"
output: html_notebook
---

This R script creates all of the figures used to compare the performance across pipelines.

This Rmarkdown file assesses the output of CheckV, DeepVirFinder, Kaiju,
VIBRANT, VirSorter, and VirSorter2 on multiple training sets of microbial DNA, 
primarily from NCBI. Created from fungal, viral, bacterial, archeael, protist,
and plasmid DNA sequences

Please reach out to James Riddell (riddell.26@buckeyemail.osu.edu) or
Bridget Hegarty (beh53@case.edu) regarding any issues, or open an issue on github.

```{r setup-library}
library(ggplot2)
library(plyr)
library(reshape2)
library(viridis)
library(tidyr)
library(dplyr)
library(readr)
library(data.table)
library(pROC)
library("stringr")
```

Import the file that combines the results from each of the tools from running "combining_tool_output.Rmd":
```{r}
viruses <- read_tsv("../IntermediaryFiles/viral_tools_combined.tsv")
```

```{r}
viruses$kaiju_match_ratio <- viruses$len/viruses$checkv_length
```


Function that allows for the comparing pieces of the pipeline
```{r getting_viral_set_1}
getting_viral_set_1 <- function(input_seqs,
                                include_vibrant=FALSE, 
                                include_virsorter2=FALSE,
                                include_deepvirfinder=FALSE,
                                include_tuning_viral=FALSE,
                                tv_1=T, tv_2=T, tv_3=T, tv_4=T,
                                include_tuning_not_viral=FALSE,
                                ntv_1=T, ntv_2=T, ntv_3=T, ntv_4=T, ntv_5=F,
                                include_virsorter=FALSE) {
  
  keep_score <- rep(0, nrow(input_seqs))

  if (include_vibrant) {
    keep_score[input_seqs$vibrant_quality=="high quality draft"] <- keep_score[input_seqs$vibrant_quality=="high quality draft"] + 1
    keep_score[input_seqs$vibrant_quality=="medium quality draft"] <- keep_score[input_seqs$vibrant_quality=="medium quality draft"] + 1
    keep_score[input_seqs$vibrant_quality=="low quality draft" & input_seqs$provirus] <- keep_score[input_seqs$vibrant_quality=="low quality draft" & input_seqs$provirus] + 0.5
  }
  
  if (include_virsorter2) {
    keep_score[input_seqs$max_score>=0.50] <- keep_score[input_seqs$max_score>=0.50] + 0.5
    keep_score[input_seqs$max_score>=0.95] <- keep_score[input_seqs$max_score>=0.95] + 0.5  
  }
  
  if (include_virsorter) {
    keep_score[input_seqs$category==1] <- keep_score[input_seqs$category==1] + 1
    keep_score[input_seqs$category==2] <- keep_score[input_seqs$category==2] + 0.5
    keep_score[input_seqs$category==3] <- keep_score[input_seqs$category==3] + 0.5
    keep_score[input_seqs$category==4] <- keep_score[input_seqs$category==4] + 1
    keep_score[input_seqs$category==5] <- keep_score[input_seqs$category==5] + 0.5 
    keep_score[input_seqs$category==6] <- keep_score[input_seqs$category==6] + 0.5 
  }
  
  if (include_deepvirfinder) {
     # add if DVF calls viral
    keep_score[(input_seqs$score>=0.9 & input_seqs$pvalue<=0.05) & input_seqs$checkv_length<20000] <- keep_score[(input_seqs$score>=0.9 & input_seqs$pvalue<=0.05) & input_seqs$checkv_length<20000] + 0.5
    keep_score[(input_seqs$score>=0.7 & input_seqs$pvalue<=0.05) & input_seqs$checkv_length<20000] <- keep_score[(input_seqs$score>=0.7 & input_seqs$pvalue<=0.05) & input_seqs$checkv_length<20000] + 0.5
  }
  
  if (include_tuning_viral) {
    keep_score <- tuning_viral(current_score=keep_score,
                               ins=input_seqs,
                         include_tv_1=tv_1,
                         include_tv_2=tv_2,
                         include_tv_3=tv_3,
                         include_tv_4=tv_4)
  }
  
  if (include_tuning_not_viral) {
    # tuning removal 
    keep_score <- tuning_not_viral(current_score=keep_score,
                               ins=input_seqs,
                         include_tv_1=ntv_1,
                         include_tv_2=ntv_2,
                         include_tv_3=ntv_3,
                         include_tv_4=ntv_4,
                         include_tv_5=ntv_5)
   
  }
  
  return(keep_score)
  
}

tuning_viral <- function(current_score, ins, 
                         include_tv_1=T,
                         include_tv_2=T,
                         include_tv_3=T,
                         include_tv_4=T) {
    # tuning addition
  if (include_tv_1) {
    current_score[ins$hallmark>2] <- current_score[ins$hallmark>2] + 1
  }
  if (include_tv_2) {
    current_score[ins$Kaiju_Viral=="Viruses" & ins$kaiju_match_ratio>=0.3] <- current_score[ins$Kaiju_Viral=="Viruses" & ins$kaiju_match_ratio>=0.3] + 1
  }
    #note: had tried pulling out this rule, but better recall without sacrificing precision with it in
    #note: having kaiju removal rule didn't help
  if (include_tv_3) {
    current_score[ins$percent_unknown>=75 & ins$checkv_length<50000] <- current_score[ins$percent_unknown>=75 & ins$checkv_length<50000] + 0.5
  }
  if (include_tv_4) {
    current_score[ins$viral>=50 | ins$percent_viral>=50] <- current_score[ins$viral>=50 | ins$percent_viral>=50] + 0.5 
  }
  return(current_score)
}

tuning_not_viral <- function(current_score, ins, 
                         include_tv_1=T,
                         include_tv_2=T,
                         include_tv_3=T,
                         include_tv_4=T,
                         include_tv_5=F) {
    # tuning removal
  if (include_tv_2) {
    current_score[ins$checkv_viral_genes==0 & ins$checkv_host_genes>=1] <- current_score[ins$checkv_viral_genes==0 & ins$checkv_host_genes>=1] - 1
  }
  if (include_tv_3) {
    current_score[((ins$checkv_viral_genes*3) <= ins$checkv_host_genes) & !ins$provirus] <- current_score[((ins$checkv_viral_genes*3) <= ins$checkv_host_genes) & !ins$provirus] - 1
  }
  
  if (include_tv_5) {
    # remove if DVF calls it not viral
    current_score[ins$score<=0.7 & ins$pvalue<=0.05] <- current_score[ins$score<=0.7 & ins$pvalue<=0.05] - 1 
  }
  
  if (include_tv_1) {
    current_score[(ins$checkv_host_genes>50) & !ins$provirus] <- -3
  }
  
  if (include_tv_4) {
    current_score[ins$checkv_length>500000 & ins$hallmark<=1] <- -3
  }
  
  return(current_score)
}
```

# Assessing performance against the "truth"
note that this is only as accurate as the annotations of the input sequences

this function calculates the precision, recall, and F1 score for each pipeline
```{r}
assess_performance <- function(seqtype, keep_score) {
  
  truepositive <- rep("not viral", length(seqtype))
  truepositive[seqtype=="virus"] <- "viral"
  
  #make confusion matrix
  confusion_matrix <- rep("true negative", length(keep_score))
  confusion_matrix[truepositive=="viral" & keep_score<=1] <- "false negative"
  confusion_matrix[truepositive=="viral" & keep_score>=1] <- "true positive"
  confusion_matrix[truepositive=="not viral" & keep_score>=1] <- "false positive"
  
  TP <- table(confusion_matrix)[4]
  FP <- table(confusion_matrix)[2]
  TN <- table(confusion_matrix)[3]
  FN <- table(confusion_matrix)[1]
  
  precision <- TP/(TP+FP)
  recall <- TP/(TP+FN)
  F1 <- 2*precision*recall/(precision+recall)
  
  MCC <- (TP*TN-FP*FN)/sqrt(as.numeric(TP+FP)*as.numeric(TP+FN)*as.numeric(TN+FP)*as.numeric(TN+FN))
  
  prop_viral <- (TP+FP)/(TP+FP+TN+FN)
  
  performance <- c(precision, recall, F1, MCC, prop_viral)
  names(performance) <- c("precision", "recall", "F1", "MCC", "prop_viral")
  
  return(performance)
}
```

combination of tools list
```{r}
combos_list <- data.frame(toolcombo=rep(0, 64),
                          tune_not_viral=rep(0, 64),
                          DVF=rep(0, 64),
                          tune_viral=rep(0, 64),
                          VIBRANT=rep(0, 64),
                          VS=rep(0, 64),
                          VS2=rep(0, 64))
p <- 1

for (i in c(0,1)){
  for (j in c(0,1)){
    for (k in c(0,1)){
      for (l in c(0,1)){
        for (m in c(0,1)){
          for (n in c(0,1)){
            combos_list$toolcombo[p] <- paste(i,j,k,l,m,n)
            combos_list$toolcombo2[p] <- paste(if(i){"tv"}else{"0"},if(j){"DVF"}else{"0"},
                                               if(k){"tnv"}else{"0"},if(l){"VB"}else{"0"},
                                               if(m){"VS"}else{"0"},if(n){"VS2"}else{"0"})
            combos_list$tune_not_viral[p] <- k
            combos_list$DVF[p] <- j
            combos_list$tune_viral[p] <- i
            combos_list$VIBRANT[p] <- l
            combos_list$VS[p] <- m
            combos_list$VS2[p] <- n
            p <- p+1
          }
        }
      }
    }
  }
}

combos_list <- combos_list[-1,]
```

this function builds a list of all of the combinations that the user wants to 
test. 
In this case, we're comparing the performance of all unique combinations of the 
six tools.
```{r}
build_score_list <- function(input_seqs, combos) {
  output <- data.frame(precision=rep(0, nrow(combos)),
                       recall=rep(0, nrow(combos)),
                       F1=rep(0, nrow(combos)),
                       MCC=rep(0, nrow(combos)),
                       prop_viral=rep(0, nrow(combos)))
  for (i in 1:nrow(combos)) {
    keep_score <- getting_viral_set_1(input_seqs, include_vibrant = combos$VIBRANT[i],
                                            include_virsorter = combos$VS[i],
                                            include_virsorter2 = combos$VS2[i],
                                            include_tuning_viral = combos$tune_viral[i],
                                            include_tuning_not_viral = combos$tune_not_viral[i],
                                            include_deepvirfinder = combos$DVF[i])
  
    output[i,1:5] <- assess_performance(input_seqs$seqtype, keep_score)
    
    output$toolcombo[i] <- paste(combos$tune_viral[i],combos$DVF[i],
                                 combos$tune_not_viral[i], combos$VIBRANT[i],
                                 combos$VS[i], combos$VS2[i])
  }
  
  output[is.na(output)] <- 0

  return (output)
}
```

## Calculate the performance of each pipeline
quantifying variability between rule sets
```{r}
accuracy_scores <- data.frame(testing_set_index=rep(0, nrow(combos_list)*8),
                      precision=rep(0, nrow(combos_list)*8),
                       recall=rep(0, nrow(combos_list)*8),
                       F1=rep(0, nrow(combos_list)*8),
                       MCC=rep(0, nrow(combos_list)*8), 
                      prop_viral=rep(0, nrow(combos_list)*8))

accuracy_scores <- cbind(testing_set_index=rep(1, nrow(combos_list)),
                              build_score_list(viruses[viruses$Index==1,], combos_list))
for (i in 2:8) {
  accuracy_scores <- rbind(accuracy_scores,
                           cbind(testing_set_index=rep(i, nrow(combos_list)),
                              build_score_list(viruses[viruses$Index==i,], combos_list)))
}
```

```{r}
pal <- ggthemes::tableau_color_pal(palette="Tableau 10", type="regular")
```

```{r}
MCC_sd_quant <- cbind(accuracy_scores$toolcombo[accuracy_scores$testing_set_index==1], as.data.frame(matrix(data=0, nrow=63, ncol=7)))

for (i in (2:8)) {
  temp <- accuracy_scores %>%
    filter(testing_set_index<=i) %>%
    select(MCC, toolcombo) %>%
    group_by(toolcombo) %>%
    summarise(sd = sd(MCC))
  
  MCC_sd_quant[,i] <- temp$sd
}

colnames(MCC_sd_quant) <- c("testing_set_index", "1-2", "1-3", "1-4",
                            "1-5", "1-6", "1-7", "1-8")

MCC_sd_quant <- MCC_sd_quant %>% pivot_longer(cols=contains("-"))

ggplot(MCC_sd_quant, aes(x=testing_set_index, y=value, 
                                  color=name, fill=name)) +
  geom_point(alpha=0.5)

ggplot(MCC_sd_quant, aes(x=name, y=value)) +
  geom_boxplot(alpha=0.5, color=pal(4)[1]) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 0),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Testing Sets") +
  ylab("Standard Deviation") 
```


## Calculate the performance of each pipeline
```{r}
accuracy_scores <- accuracy_scores %>% filter(testing_set_index<=5)
```


```{r}
accuracy_scores$numrules <- str_count(accuracy_scores$toolcombo, "1")
#accuracy_scores <- accuracy_scores[order(accuracy_scores$numrules, decreasing=F),]
accuracy_scores <- accuracy_scores[order(accuracy_scores$MCC, decreasing=F),]
accuracy_scores$toolcombo <- factor(accuracy_scores$toolcombo, levels = unique(accuracy_scores$toolcombo))
```

accounting for rules that have multiple tools in them
```{r}
accuracy_scores$numtools <- accuracy_scores$numrules

for (i in 1:nrow(accuracy_scores)) {
  toolcombo <- as.character(accuracy_scores$toolcombo[i])
  if (substr(toolcombo, 1, 1)=="1") {
    accuracy_scores$numtools[i] <- accuracy_scores$numtools[i] + 3
  }
  
  if (substr(toolcombo, 5, 5)=="1") {
    accuracy_scores$numtools[i] <- accuracy_scores$numtools[i] + 4
  }
}

accuracy_scores$numtools[accuracy_scores$numtools>6] <- 6
```

```{r}
accuracy_scores$numrules <- as.factor(accuracy_scores$numrules)
accuracy_scores$numtools <- as.factor(accuracy_scores$numtools)
```

```{r}
accuracy_scores$ruletype <- "other"
accuracy_scores$ruletype[accuracy_scores$toolcombo %in% c("0 0 1 0 0 1",
                                                          "0 0 1 1 0 0",
                                                          "0 0 0 1 0 0")] <- "high precision"
accuracy_scores$ruletype[accuracy_scores$toolcombo %in% c("1 1 0 0 1 1",
                                                          "1 1 0 1 1 1",
                                                          "1 1 0 0 0 1",
                                                          "1 1 0 1 0 1")] <- "high recall"
accuracy_scores$ruletype[accuracy_scores$toolcombo %in% c("0 0 1 0 0 1",
                                                          "0 1 1 0 0 1",
                                                          "0 0 0 0 0 1",
                                                          "1 0 1 1 0 1",
                                                          "1 0 1 0 1 1",
                                                          "1 0 1 0 0 1")] <- "high MCC"
#accuracy_scores$ruletype[accuracy_scores$toolcombo %in% c("0 0 1 0 0 1")] <- "high MCC and high precision"
accuracy_scores$ruletype[accuracy_scores$toolcombo %in% c("1 1 1 1 1 1")] <- "all"


```

```{r}
accuracy_scores_melt <- accuracy_scores %>% 
  select(testing_set_index, precision, recall, MCC, prop_viral, numrules, numtools, toolcombo, ruletype) %>%
  pivot_longer(cols=c(precision, recall, MCC, prop_viral), 
               names_to="performance_metric",
               values_to="performance_metric_score")
```


```{r}
fig <- ggplot(accuracy_scores_melt[accuracy_scores_melt$performance_metric=="prop_viral",], 
              aes(x=ruletype, y=performance_metric_score, 
                                  color=ruletype, fill=ruletype)) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=10),
    axis.text.x=element_text(size=12, angle = 90, vjust = -0.1),
    legend.text=element_text(size=12),
    axis.title=element_text(size=12),
    strip.background = element_rect(fill="white", color="grey"),
    strip.text = element_text(color="black", size=12)
  ) +
  xlab("Environment") +
  ylab("Proportion Called Viral") +
  scale_fill_manual(name="",
                     values = alpha(c(rev(magma(7)[3:6]), "grey"), 0.4)) +
  scale_color_manual(name="",
                     values = alpha(c(rev(magma(7)[3:6]), "grey"), 0.6)) +
  geom_hline(yintercept = 0.1, linetype="dashed", color="dark grey")

fig
```

```{r}
ggsave(
  "../IntermediaryFiles/simplified_performance_metricrule_types.png",
  plot = fig,
  scale = 1,
  width = 6.5,
  height = 4,
  units = c("in"),
  dpi = 300,
  limitsize = TRUE
)
```

visualizing change when add the tnv rule
```{r}
accuracy_scores_one_ts <- accuracy_scores[accuracy_scores$testing_set_index==1,]

tnv <- rep(NA, 63)

for (i in 1:nrow(accuracy_scores_one_ts)) {
  tnv[i] <- as.numeric(substr(accuracy_scores_one_ts$toolcombo[i], 5, 5))
}

num_no_tnv <- 63-(sum(tnv))
```

```{r}
no_tnv_prop <- data.frame(tool_combo=accuracy_scores_one_ts$toolcombo[grep("0", tnv)],
                          prop_viral=rep(0, num_no_tnv),
                          MCC=rep(0, num_no_tnv),
                          precision=rep(0, num_no_tnv),
                          recall=rep(0, num_no_tnv))

tc_tnv <- "0"
tc_no_tnv <- "0"
prop_tnv <- 0
j <- 1

for (i in grep("0", tnv)) {
  tc_no_tnv <- as.character(accuracy_scores_one_ts$toolcombo[i])
  tc_tnv <- tc_no_tnv
  substr(tc_tnv, 5, 5) <- "1"
  
  prop_tnv <- accuracy_scores_one_ts$prop_viral[grep(tc_tnv,accuracy_scores_one_ts$toolcombo)][1]
  no_tnv_prop$prop_viral[j] <-
    (prop_tnv-accuracy_scores_one_ts$prop_viral[i])/prop_tnv*100
  
  prop_tnv <- accuracy_scores_one_ts$MCC[grep(tc_tnv,accuracy_scores_one_ts$toolcombo)][1]
  no_tnv_prop$MCC[j] <-
    (prop_tnv-accuracy_scores_one_ts$MCC[i])/prop_tnv*100
  
  prop_tnv <- accuracy_scores_one_ts$precision[grep(tc_tnv,accuracy_scores_one_ts$toolcombo)][1]
  no_tnv_prop$precision[j] <-
    (prop_tnv-accuracy_scores_one_ts$precision[i])/prop_tnv*100
  
  prop_tnv <- accuracy_scores_one_ts$recall[grep(tc_tnv,accuracy_scores_one_ts$toolcombo)][1]
  no_tnv_prop$recall[j] <-
    (prop_tnv-accuracy_scores_one_ts$recall[i])/prop_tnv*100
  
  
  
  j <- j+1
}



mean(no_tnv_prop$prop_viral)
sd(no_tnv_prop$prop_viral)

no_tnv_prop_melt <- no_tnv_prop %>% 
  select(precision, recall, MCC, prop_viral, tool_combo) %>%
  pivot_longer(cols=c(precision, recall, MCC, prop_viral), 
               names_to="performance_metric",
               values_to="performance_metric_percent_diff")

```

visualizing when add the tuning addition rule
```{r}
accuracy_scores_one_ts <- accuracy_scores[accuracy_scores$testing_set_index==1,]

tv <- rep(NA, 63)

for (i in 1:nrow(accuracy_scores_one_ts)) {
  tv[i] <- as.numeric(substr(accuracy_scores_one_ts$toolcombo[i], 1, 1))
}

num_no_tv <- 63-(sum(tv))

no_tv_prop <- data.frame(tool_combo=accuracy_scores_one_ts$toolcombo[grep("0", tv)],
                          prop_viral=rep(0, num_no_tv),
                          MCC=rep(0, num_no_tv),
                          precision=rep(0, num_no_tv),
                          recall=rep(0, num_no_tv))

tc_tv <- "0"
tc_no_tv <- "0"
prop_tv <- 0
j <- 1

for (i in grep("0", tv)) {
  tc_no_tv <- as.character(accuracy_scores_one_ts$toolcombo[i])
  tc_tv <- tc_no_tv
  substr(tc_tv, 1, 1) <- "1"
  
  prop_tv <- accuracy_scores_one_ts$prop_viral[grep(tc_tv,accuracy_scores_one_ts$toolcombo)][1]
  no_tv_prop$prop_viral[j] <-
    (prop_tv-accuracy_scores_one_ts$prop_viral[i])/prop_tv*100
  
  prop_tv <- accuracy_scores_one_ts$MCC[grep(tc_tv,accuracy_scores_one_ts$toolcombo)][1]
  no_tv_prop$MCC[j] <-
    (prop_tv-accuracy_scores_one_ts$MCC[i])/prop_tv*100
  
  prop_tv <- accuracy_scores_one_ts$precision[grep(tc_tv,accuracy_scores_one_ts$toolcombo)][1]
  no_tv_prop$precision[j] <-
    (prop_tv-accuracy_scores_one_ts$precision[i])/prop_tv*100
  
  prop_tv <- accuracy_scores_one_ts$recall[grep(tc_tv,accuracy_scores_one_ts$toolcombo)][1]
  no_tv_prop$recall[j] <-
    abs(prop_tv-accuracy_scores_one_ts$recall[i])/prop_tv*100
  
  
  
  j <- j+1
}

mean(no_tv_prop$prop_viral)
sd(no_tv_prop$prop_viral)

no_tv_prop_melt <- no_tv_prop %>% 
  select(precision, recall, MCC, prop_viral, tool_combo) %>%
  pivot_longer(cols=c(precision, recall, MCC, prop_viral), 
               names_to="performance_metric",
               values_to="performance_metric_percent_diff")
```

```{r}
no_tv_and_ntv_prop_melt <- rbind(no_tv_prop_melt, no_tnv_prop_melt)

no_tv_and_ntv_prop_melt$set <- c(rep("tuning addition", nrow(no_tv_prop_melt)),
                                 rep("tuning removal", nrow(no_tnv_prop_melt)))

pal <- ggthemes::tableau_color_pal(palette="Tableau 10", type="regular")


fig <- ggplot(no_tv_and_ntv_prop_melt, 
              aes(x=performance_metric, y=performance_metric_percent_diff,
                  color=set, fill=set)) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=10),
    axis.text.x=element_text(size=12),
    legend.text=element_text(size=12),
    axis.title=element_text(size=12),
    strip.background = element_rect(fill="white", color="grey"),
    strip.text = element_text(color="black", size=12)
  ) +
  xlab("Performance Metric") +
  ylab("Percent Difference") +
  geom_hline(yintercept = 1, color="grey") +
  scale_fill_manual(name="",
                     values = alpha(c(pal(6)[c(6,1)]), 0.4)) +
  scale_color_manual(name="",
                     values = alpha(c(pal(6)[c(6,1)]), 0.6))

fig
```

### Visualize performance across all the rules 


## Visualize how the precision, recall, and MCC changes across pipelines.
precision
```{r}
accuracy_scores <- accuracy_scores[order(accuracy_scores$precision, decreasing=F),]
accuracy_scores$toolcombo <- factor(accuracy_scores$toolcombo, levels = unique(accuracy_scores$toolcombo))

ggplot(accuracy_scores, aes(x=toolcombo, y=precision, 
                                  color=numrules, fill=numrules)) +
  geom_point(alpha=0.5) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Tool Combination (tv, DVF, tnv, VB, VS, VS2)") +
  ylab("Precision") +
  scale_fill_manual(name="Number of Rules",
                     values = alpha(rev(viridis(6)), 0.5)) +
  scale_color_manual(name="Number of Rules",
                     values = alpha(rev(viridis(6)), 1))

ggplot(accuracy_scores, aes(x=toolcombo, y=precision, 
                                  color=ruletype, fill=ruletype)) +
  geom_boxplot(alpha=0.5) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Tool Combination (tv, DVF, tnv, VB, VS, VS2)") +
  ylab("Precision") +
  scale_fill_manual(name="",
                     values = alpha(c(rev(magma(7)[3:6]), "grey"), 0.4)) +
  scale_color_manual(name="",
                     values = alpha(c(rev(magma(7)[3:6]), "grey"), 0.6))
```

```{r}
mean_precision <- accuracy_scores %>% 
  select(precision, toolcombo) %>%
  group_by(toolcombo) %>%
  summarise(mean = mean(precision))
```

getting set of tools with roughly equivalent precision
```{r}
t.test(accuracy_scores$precision[accuracy_scores$toolcombo=="0 0 1 0 0 1"], 
       accuracy_scores$precision[accuracy_scores$toolcombo=="0 0 1 1 0 0"])

t.test(accuracy_scores$precision[accuracy_scores$toolcombo=="0 0 1 0 0 1"], 
       accuracy_scores$precision[accuracy_scores$toolcombo=="0 0 0 1 0 0"])

t.test(accuracy_scores$precision[accuracy_scores$toolcombo=="0 0 1 0 0 1"], 
       accuracy_scores$precision[accuracy_scores$toolcombo=="0 0 0 0 0 1"])

t.test(accuracy_scores$precision[accuracy_scores$toolcombo=="0 0 1 0 0 1"], 
       accuracy_scores$precision[accuracy_scores$toolcombo=="0 0 1 1 0 1"])
```
accounting for multiple t-tests with Bonferroni, then the following have the same precision:
- vs2+tnv, vb+tnv, vb, and vs2


recall
```{r}
accuracy_scores <- accuracy_scores[order(accuracy_scores$recall, decreasing=F),]
accuracy_scores$toolcombo <- factor(accuracy_scores$toolcombo, levels = unique(accuracy_scores$toolcombo))

ggplot(accuracy_scores, aes(x=toolcombo, y=recall, 
                                  color=numrules, fill=numrules)) +
  geom_point(alpha=0.5) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Tool Combination (tv, DVF, tnv, VB, VS, VS2)") +
  ylab("Recall") +
  scale_fill_manual(name="Number of Rules",
                     values = alpha(rev(viridis(6)), 0.5)) +
  scale_color_manual(name="Number of Rules",
                     values = alpha(rev(viridis(6)), 1))

ggplot(accuracy_scores, aes(x=toolcombo, y=recall, 
                                  color=ruletype, fill=ruletype)) +
  geom_boxplot(alpha=0.5) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Tool Combination (tv, DVF, tnv, VB, VS, VS2)") +
  ylab("Recall") +
  scale_fill_manual(name="",
                     values = alpha(c(rev(magma(7)[3:6]), "grey"), 0.4)) +
  scale_color_manual(name="",
                     values = alpha(c(rev(magma(7)[3:6]), "grey"), 0.6))
```

```{r}
mean_recall <- accuracy_scores %>% 
  select(recall, toolcombo) %>%
  group_by(toolcombo) %>%
  summarise(mean = mean(recall))
```

getting set of tools with roughly equivalent recall
```{r}
t.test(accuracy_scores$recall[accuracy_scores$toolcombo=="1 1 0 0 1 1"], 
       accuracy_scores$recall[accuracy_scores$toolcombo=="1 1 0 1 1 1"])

t.test(accuracy_scores$recall[accuracy_scores$toolcombo=="1 1 0 0 1 1"], 
       accuracy_scores$recall[accuracy_scores$toolcombo=="1 1 0 0 0 1"])

t.test(accuracy_scores$recall[accuracy_scores$toolcombo=="1 1 0 0 1 1"], 
       accuracy_scores$recall[accuracy_scores$toolcombo=="1 1 0 1 0 1"])

t.test(accuracy_scores$recall[accuracy_scores$toolcombo=="1 1 0 0 1 1"], 
       accuracy_scores$recall[accuracy_scores$toolcombo=="1 0 0 0 1 1"])

t.test(accuracy_scores$recall[accuracy_scores$toolcombo=="1 1 0 0 1 1"], 
       accuracy_scores$recall[accuracy_scores$toolcombo=="1 0 0 1 1 1"])

t.test(accuracy_scores$recall[accuracy_scores$toolcombo=="1 1 0 0 1 1"], 
       accuracy_scores$recall[accuracy_scores$toolcombo=="1 1 1 0 1 1"])
```
accounting for multiple t-tests with Bonferroni, then the following have the same recall:
- vs2+vs+dvf+tv, vs2+vs+dvf+tv+vb, vs2+dvf+tv, vs2+vs+dvf+tv, vs2+dvf+tv+vb, 


precision vs recall
```{r}
ggplot(accuracy_scores, aes(x=precision, y=recall, 
                                  color=numrules, fill=numrules)) +
  geom_point(alpha=0.5) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=20),
  ) +
  xlab("Precision") +
  ylab("Recall") +
  scale_fill_manual(name="Number of Rules",
                     values = alpha(rev(viridis(6)), 0.5)) +
  scale_color_manual(name="Number of Rules",
                     values = alpha(rev(viridis(6)), 1))

ggplot(accuracy_scores, aes(x=precision, y=recall, 
                                  color=numtools, fill=numtools)) +
  geom_point(alpha=0.5) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=20),
  ) +
  xlab("Precision") +
  ylab("Recall") +
  scale_fill_manual(name="Number of Tools",
                     values = alpha(rev(pal(6)), 0.5)) +
  scale_color_manual(name="Number of Tools",
                     values = alpha(rev(pal(6)), 1))

```
MCC
```{r}
mean_MCC <- accuracy_scores %>% 
  select(MCC, toolcombo) %>%
  group_by(toolcombo) %>%
  summarise(mean = mean(MCC)) %>%
  arrange(mean)
```

```{r}
accuracy_scores$toolcombo <- factor(accuracy_scores$toolcombo, levels = mean_MCC$toolcombo)

fig <- ggplot(accuracy_scores, aes(x=toolcombo, y=MCC, 
                                  color=ruletype, fill=ruletype)) +
  geom_boxplot(alpha=0.5) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Tool Combination (tv, DVF, tnv, VB, VS, VS2)") +
  ylab("MCC") +
  scale_fill_manual(name="Number of Rules",
                     values = alpha(c(rev(magma(7)[3:6]), "grey"), 0.4)) +
  scale_color_manual(name="Number of Rules",
                     values = alpha(c(rev(magma(7)[3:6]), "grey"), 0.6))

fig

ggsave(
  "../IntermediaryFiles/all_MCC_scatterplot.png",
  plot = fig,
  scale = 1,
  width = 8,
  height = 4,
  units = c("in", "cm", "mm", "px"),
  dpi = 300,
  limitsize = TRUE
)

ggplot(accuracy_scores, aes(x=toolcombo, y=MCC, 
                                  color=numtools, fill=numtools)) +
  geom_point(alpha=0.5) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=20),
  ) +
  xlab("Tool Combination (tv, DVF, tnv, VB, VS, VS2)") +
  ylab("MCC") +
  scale_fill_manual(name="Number of Tools",
                     values = alpha(rev(viridis(6)), 0.5)) +
  scale_color_manual(name="Number of Tools",
                     values = alpha(rev(viridis(6)), 1))
```
```{r}
max(accuracy_scores$MCC)
```
=78

getting set of tools with roughly equivalent MCC
```{r}
t.test(accuracy_scores$MCC[accuracy_scores$toolcombo=="0 0 1 0 0 1"], 
       accuracy_scores$MCC[accuracy_scores$toolcombo=="0 1 1 0 0 1"])

t.test(accuracy_scores$MCC[accuracy_scores$toolcombo=="0 0 1 0 0 1"], 
       accuracy_scores$MCC[accuracy_scores$toolcombo=="1 0 1 0 0 1"])

t.test(accuracy_scores$MCC[accuracy_scores$toolcombo=="0 0 1 0 0 1"], 
       accuracy_scores$MCC[accuracy_scores$toolcombo=="0 0 0 0 0 1"])

t.test(accuracy_scores$MCC[accuracy_scores$toolcombo=="0 0 1 0 0 1"], 
       accuracy_scores$MCC[accuracy_scores$toolcombo=="1 0 1 1 0 1"])

t.test(accuracy_scores$MCC[accuracy_scores$toolcombo=="0 0 1 0 0 1"], 
       accuracy_scores$MCC[accuracy_scores$toolcombo=="1 0 1 0 0 1"])

t.test(accuracy_scores$MCC[accuracy_scores$toolcombo=="0 0 1 0 0 1"], 
       accuracy_scores$MCC[accuracy_scores$toolcombo=="1 0 1 0 1 1"])

t.test(accuracy_scores$MCC[accuracy_scores$toolcombo=="0 0 1 0 0 1"], 
       accuracy_scores$MCC[accuracy_scores$toolcombo=="1 1 1 0 0 1"])
```
accounting for multiple t-tests with Bonferroni, then the following have the same MCC:
- vs2+tnv, vs2+tnv+dvf, vs2, vs2+tnv+tv+vb, vs2+tnv+tv+vs   


making heatmap for the x-axis label
```{r}
ann_col = data.frame(
    tnv = combos_list$tune_not_viral,
    tv = combos_list$tune_viral,
    dvf = combos_list$DVF,
    vb = combos_list$VIBRANT,
    vs = combos_list$VS,
    vs2 = combos_list$VS2
)
rownames(ann_col) <- combos_list$toolcombo

ann_colors = list(
  tv = c("black", pal(6)[3]),
  tnv = c("black", pal(6)[1]),
  dvf = c("black", pal(6)[2]),
  vb = c("black", pal(6)[4]),
  vs = c("black", pal(6)[5]),
  vs2 = c("black", pal(6)[6])
)




viral_scores_1 <- accuracy_scores %>% filter(testing_set_index==5)
#viral_scores_1 <- mean_MCC
#rn <- viral_scores_1$toolcombo

viral_scores_1 <- viral_scores_1 %>% select(c("MCC"))
#viral_scores_1 <- viral_scores_1 %>% select(c("mean"))
rownames(viral_scores_1) <- rn

pheatmap::pheatmap(as.matrix(viral_scores_1),
                  annotation_row = ann_col,
                  annotation_colors = ann_colors,
                  border_color = NA,
                  show_rownames = T,
                  show_colnames = F,
                  annotation_legend = F,
                  cluster_rows = F,
                  cluster_cols = F,
                  cellheight=3,
                  filename = "../IntermediaryFiles/heatmap_MCC_labels.png"
                  )
```



```{r}
fig <- ggplot(accuracy_scores_melt[accuracy_scores_melt$toolcombo!="0 0 1 0 0 0" & accuracy_scores_melt$performance_metric!="prop_viral",], aes(x=numrules, y=performance_metric_score, 
                                  color=numrules, fill=numrules)) +
  geom_boxplot() +
  geom_point(alpha=0.5) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    #axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  ylab("Score") +
  xlab("Number of Rule Sets") +
  scale_fill_manual(name="Number of Rule Sets",
                     values = alpha(rev(viridis(6)), 0.5)) +
  scale_color_manual(name="Number of Rule Sets",
                     values = alpha(rev(viridis(6)), 1)) +
  facet_wrap(~performance_metric) +
  geom_hline(yintercept = 0, color="grey")
  

fig

ggsave(
  "../IntermediaryFiles/MCC_precision_recall_boxplots.png",
  plot = fig,
  scale = 1,
  width = 8,
  height = 4,
  units = c("in", "cm", "mm", "px"),
  dpi = 300,
  limitsize = TRUE
)
```

```{r}
ggplot(accuracy_scores_melt[accuracy_scores_melt$performance_metric!="MCC",], aes(x=numrules, y=performance_metric_score, 
                                  color=numrules, fill=numrules)) +
  geom_boxplot() +
  geom_point(alpha=0.5) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  ylab("Score") +
  xlab("Number of Rule Sets") +
  scale_fill_manual(name="Number of Rule Sets",
                     values = alpha(rev(viridis(6)), 0.5)) +
  scale_color_manual(name="Number of Rule Sets",
                     values = alpha(rev(viridis(6)), 1)) +
  facet_wrap(~performance_metric)

ggplot(accuracy_scores_melt[accuracy_scores_melt$performance_metric!="MCC",], aes(x=numrules, y=performance_metric_score, 
                                  color=numtools, fill=numtools)) +
  geom_boxplot() +
  geom_point(alpha=0.5) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  ylab("Score") +
  xlab("Number of Rules") +
  scale_fill_manual(name="Number of Tools",
                     values = alpha(rev(viridis(6)), 0.5)) +
  scale_color_manual(name="Number of Tools",
                     values = alpha(rev(viridis(6)), 1)) +
  facet_wrap(~performance_metric)

ggplot(accuracy_scores_melt[accuracy_scores_melt$performance_metric!="MCC",], aes(x=numtools, y=performance_metric_score, 
                                  color=numrules, fill=numrules)) +
  geom_boxplot() +
  geom_point(alpha=0.5) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  ylab("Score") +
  xlab("Number of Tools") +
  scale_fill_manual(name="Number of Rule Sets",
                     values = alpha(rev(viridis(6)), 0.5)) +
  scale_color_manual(name="Number of Rule Sets",
                     values = alpha(rev(viridis(6)), 1)) +
  facet_wrap(~performance_metric)
  
```

```{r}
one.way <- aov(precision ~ numrules, data = accuracy_scores)

summary(one.way)

TukeyHSD(one.way)
```

```{r}
one.way <- aov(recall ~ numrules, data = accuracy_scores)

summary(one.way)

TukeyHSD(one.way)
```

```{r}
one.way <- aov(MCC ~ numrules, data = accuracy_scores)

summary(one.way)

TukeyHSD(one.way)
```

```{r}
one.way <- aov(MCC ~ numtools, data = accuracy_scores)

summary(one.way)

TukeyHSD(one.way)
```

## differences based on genome size
```{r}
viruses$keep_score_high_MCC <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$confusion_matrix_high_MCC <- "true negative"
viruses$confusion_matrix_high_MCC[viruses$seqtype=="virus" & viruses$keep_score_high_MCC<1] <- "false negative"
viruses$confusion_matrix_high_MCC[viruses$seqtype=="virus" & viruses$keep_score_high_MCC>=1] <- "true positive"
viruses$confusion_matrix_high_MCC[viruses$seqtype!="virus" & viruses$keep_score_high_MCC>=1] <- "false positive"

viruses$size_class <- "3-5kb"
viruses$size_class[viruses$checkv_length>5000] <- "5-10kb"
viruses$size_class[viruses$checkv_length>10000] <- ">10kb"

confusion_by_taxa <- viruses %>% count(confusion_matrix_high_MCC, seqtype, size_class, Index)

colnames(confusion_by_taxa) <- c("confusion_matrix", "seqtype","size", "index", "count")

confusion_vir_called <- confusion_by_taxa %>% filter(confusion_matrix=="true positive" | confusion_matrix=="false positive") 

type_count <- viruses %>% count(seqtype, size_class, Index)

confusion_vir_called$per_viral <- 0

for (i in c(1:nrow(confusion_vir_called))) {
  confusion_vir_called$per_viral[i] <- confusion_vir_called$count[i]/type_count$n[type_count$seqtype==confusion_vir_called$seqtype[i] & 
                                                                                    type_count$Index==confusion_vir_called$index[i] &
                                                                                    type_count$size_class==confusion_vir_called$size[i]]*100
}
```

```{r}
confusion_vir_called_subset <- confusion_vir_called[confusion_vir_called$seqtype=="virus",]

one.way <- aov(per_viral ~ size, data = confusion_vir_called_subset)

summary(one.way)

TukeyHSD(one.way)
```

```{r}
confusion_vir_called <- confusion_vir_called %>% group_by(seqtype, size) %>%
  summarise(mean=mean(per_viral), 
            sd=sd(per_viral))

confusion_vir_called$size <- factor(confusion_vir_called$size,
                                    levels = c("3-5kb", "5-10kb", ">10kb"))
```

```{r}
ggplot(confusion_vir_called, aes(y=mean, x=size,
                   fill=seqtype,
                   color=seqtype)) +
  geom_bar(stat="identity", position=position_dodge()) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) +
  scale_fill_manual(name="",
                     values = alpha(rev(pal(6)), 0.5)) +
  scale_color_manual(name="",
                     values = alpha(rev(pal(6)), 1)) +
  xlab("Length") +
  ylab("Sequences Called Viral (%)") 
```
```{r}
one.way <- aov(mean ~ seqtype, data = confusion_vir_called)

summary(one.way)

TukeyHSD(one.way)
```


## visualizing a select set of tools
```{r}
viruses$keep_score_high_all <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)
viruses$keep_score_high_recall <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = F,
                                              include_virsorter = T)
viruses$keep_score_high_precision <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)
viruses$keep_score_high_MCC <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_high"), true_virus) %>%
  pivot_longer(cols=contains("keep_score_"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, true_virus) %>%
  summarise(n = n())

pal_purple <- RColorBrewer::brewer.pal(6, "Purples")
pal_orange <- RColorBrewer::brewer.pal(4, "Oranges")

ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_manual(name="",
                     values = alpha(c(rev(pal_orange), pal_purple), 0.8)) +
  xlab("") +
  ylab("Number of Sequences") + 
  facet_grid(~true_virus, scales = "free")
```

```{r}
viruses_long_scores <- viruses %>% 
  select(contains("keep_score_high"), max_score_group, true_virus) %>%
  filter(true_virus=="virus") %>%
  pivot_longer(cols=contains("keep_score_"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, max_score_group) %>%
  summarise(n = n())

pal_purple <- RColorBrewer::brewer.pal(6, "Purples")
pal_orange <- RColorBrewer::brewer.pal(3, "Oranges")

ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_manual(name="",
                     values = alpha(c(rev(pal_orange), pal_purple), 0.8)) +
  xlab("") +
  ylab("Number of Sequences") + 
  facet_grid(~max_score_group, scales = "free") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 2))

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_high"), max_score_group, true_virus) %>%
  filter(true_virus=="not") %>%
  pivot_longer(cols=contains("keep_score_"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, max_score_group) %>%
  summarise(n = n())

pal_purple <- RColorBrewer::brewer.pal(6, "Purples")
pal_orange <- RColorBrewer::brewer.pal(4, "Oranges")

ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_manual(name="",
                     values = alpha(c(rev(pal_orange), pal_purple), 0.8)) +
  xlab("") +
  ylab("Number of Sequences") + 
  facet_grid(~max_score_group, scales = "free") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 2))
```




### Effect of combining tools
```{r}
viruses$keep_score_dvf <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_dvf_vs <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = T)

viruses$keep_score_dvf_vs_vb <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = T)

viruses$keep_score_dvf_vs_vb_vs2 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = T)

viruses$keep_score_dvf_vs_vb_vs2_tv <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = F,
                                              include_virsorter = T)

viruses$keep_score_dvf_vs_vb_vs2_tv_tnv <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_dvf"), size_class, seqtype) %>%
  pivot_longer(cols=contains("keep_score_"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, size_class, seqtype) %>%
  summarise(n = n())

viruses_long_scores$size_class <- factor(viruses_long_scores$size_class,
                                    levels = c("3-5kb", "5-10kb", ">10kb"))
```

```{r}
ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_brewer(palette = "PuOr", ) +
  xlab("") +
  ylab("Number of Sequences") + 
  scale_x_discrete(labels=c("DVF", "DVF+VS", "DVF+VS+VB", "DVF+VS+VB+VS2",
                            "DVF+VS+VB+VS2+addition", "DVF+VS+VB+VS2+addition-removal")) +
  facet_grid(~seqtype, scales = "free")
```


### Effect of tuning rules - subset
```{r}
viruses$keep_score_all_ntv_all <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              tv_1=T, tv_2=T, tv_3=F, tv_4=T,
                                              include_tuning_viral = T,
                                              ntv_1=T, ntv_2=T, ntv_3=T, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)
viruses$keep_score_all_ntv_neither <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = T)

viruses$keep_score_all_ntv_0 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              tv_1=T, tv_2=T, tv_3=F, tv_4=T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = F,
                                              ntv_1=F, ntv_2=F, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_virsorter = T)

viruses$keep_score_all_ntv_1 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              tv_1=T, tv_2=T, tv_3=F, tv_4=T,
                                              include_tuning_viral = T,
                                              ntv_1=T, ntv_2=F, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_ntv_2 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              tv_1=T, tv_2=T, tv_3=F, tv_4=T,
                                              include_tuning_viral = T,
                                              ntv_1=F, ntv_2=T, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_ntv_3 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              tv_1=T, tv_2=T, tv_3=F, tv_4=T,
                                              include_tuning_viral = T,
                                              ntv_1=F, ntv_2=F, ntv_3=T, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_tv_0 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=T, ntv_2=T, ntv_3=T, ntv_4=F, ntv_5=F,
                                              include_virsorter = T)

viruses$keep_score_all_tv_1 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=T, tv_2=F, tv_3=F, tv_4=F,
                                              ntv_1=T, ntv_2=T, ntv_3=T, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_tv_2 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=F, tv_2=T, tv_3=F, tv_4=F,
                                              ntv_1=T, ntv_2=T, ntv_3=T, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_tv_4 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=F, tv_2=F, tv_3=F, tv_4=T,
                                              ntv_1=T, ntv_2=T, ntv_3=T, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)


viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_all_"), seqtype) %>%
  pivot_longer(cols=contains("keep_score_"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, seqtype) %>%
  summarise(n = n()) 

viruses_long_scores$tuning_type <- "tuning addition"
viruses_long_scores$tuning_type[grepl("ntv", viruses_long_scores$rule_combination)] <- "tuning removal"
viruses_long_scores$tuning_type[viruses_long_scores$rule_combination=="keep_score_all_ntv_all"] <- "all"
viruses_long_scores$tuning_type[viruses_long_scores$rule_combination=="keep_score_all_ntv_neither"] <- "neither"

fig <- ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom",
    strip.background = element_rect(fill="white", color="grey"),
    strip.text = element_text(color="black")
  ) +
  scale_fill_manual(name="Viral Score",
                     values = alpha(c(rev(RColorBrewer::brewer.pal(9,"Oranges")[4:7]),
                            RColorBrewer::brewer.pal(9,"Purples")[4:9] 
                            ), 0.8)) +
  xlab("Ruleset") +
  ylab("Proportion") + 
  facet_grid(tuning_type~seqtype, scales = "free") 

fig

ggsave(
  "../IntermediaryFiles/tuning_rulesets.png",
  plot = fig,
  scale = 1,
  width = 8,
  height = 6,
  units = c("in"),
  dpi = 300,
  limitsize = TRUE
)

```





### Effect of tuning addition rules
```{r}
viruses$keep_score_all_tv_all <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_tv_1 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=T, tv_2=F, tv_3=F, tv_4=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_tv_2 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=T, tv_2=T, tv_3=F, tv_4=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_tv_3 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=T, tv_2=T, tv_3=T, tv_4=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_tv_0 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              tv_1=F, tv_2=F, tv_3=F, tv_4=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_all_tv"), seqtype) %>%
  pivot_longer(cols=contains("keep_score_"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, seqtype) %>%
  summarise(n = n())

fig <- ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom",
    strip.background = element_rect(fill="white", color="grey"),
    strip.text = element_text(color="black")
  ) +
  scale_fill_manual(name="Viral Score",
                     values = alpha(c(rev(RColorBrewer::brewer.pal(9,"Oranges")[4:7]),
                            RColorBrewer::brewer.pal(9,"Purples")[4:9] 
                            ), 0.8)) +
  xlab("Ruleset") +
  ylab("Proportion") + 
  facet_grid(~seqtype, scales = "free") 

fig

ggsave(
  "../IntermediaryFiles/tuning_addition_rulesets_all.png",
  plot = fig,
  scale = 1,
  width = 8,
  height = 4,
  units = c("in"),
  dpi = 300,
  limitsize = TRUE
)
```

same idea but VS2 base
```{r}
viruses$keep_score_vs2_tv_all <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_vs2_tv_4_tv_2 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=F, tv_2=T, tv_3=F, tv_4=T,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_vs2_tv_4_tv_2_tv_1 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=T, tv_2=T, tv_3=F, tv_4=T,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_vs2_tv_1 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=T, tv_2=F, tv_3=F, tv_4=F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_vs2_tv_2 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=F, tv_2=T, tv_3=F, tv_4=F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_vs2_tv_3 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=F, tv_2=F, tv_3=T, tv_4=F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_vs2_tv_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=F, tv_2=F, tv_3=F, tv_4=T,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_vs2_tv_0 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)
                                              
 viruses$keep_score_vs2_tv_ntv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)                                             

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_vs2_tv_"), seqtype) %>%
  pivot_longer(cols=contains("keep_score_"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, seqtype) %>%
  summarise(n = n())
```

```{r}
fig <- ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom",
    strip.background = element_rect(fill="white", color="grey"),
    strip.text = element_text(color="black")
  ) +
  scale_fill_manual(name="Viral Score",
                     values = alpha(c(rev(RColorBrewer::brewer.pal(9,"Oranges")[4:7]),
                            RColorBrewer::brewer.pal(9,"Purples")[4:9] 
                            ), 0.8)) +
  xlab("Ruleset") +
  ylab("Proportion") + 
  facet_grid(~seqtype, scales = "free") 

fig
```


### Effect of tuning removal rules
```{r}
viruses$keep_score_all_ntv_all <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_ntv_1 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              ntv_1=T, ntv_2=F, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_ntv_2 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              ntv_1=F, ntv_2=T, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_ntv_3 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              ntv_1=F, ntv_2=F, ntv_3=T, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_ntv_4 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              ntv_1=F, ntv_2=F, ntv_3=F, ntv_4=T, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_ntv_5 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              ntv_1=F, ntv_2=F, ntv_3=F, ntv_4=F, ntv_5=T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = T)

viruses$keep_score_all_ntv_0 <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = T,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              ntv_1=F, ntv_2=F, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = T)

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_all_ntv"), seqtype) %>%
  pivot_longer(cols=contains("keep_score_"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, seqtype) %>%
  summarise(n = n())

fig <- ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom",
    strip.background = element_rect(fill="white", color="grey"),
    strip.text = element_text(color="black")
  ) +
  scale_fill_manual(name="Viral Score",
                     values = alpha(c(rev(RColorBrewer::brewer.pal(9,"Oranges")[4:7]),
                            RColorBrewer::brewer.pal(9,"Purples")[4:9] 
                            ), 0.8)) +
  xlab("Ruleset") +
  ylab("Proportion") + 
  facet_grid(~seqtype, scales = "free") 

fig

ggsave(
  "../IntermediaryFiles/tuning_removal_rulesets-all.png",
  plot = fig,
  scale = 1,
  width = 8,
  height = 4,
  units = c("in"),
  dpi = 300,
  limitsize = TRUE
)
```

```{r}
table(viruses$keep_score_all_ntv_0, viruses$keep_score_all_ntv_1)
```

```{r}
table(viruses$keep_score_all_ntv_4, viruses$keep_score_all_ntv_5)
```


```{r}
ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_manual(name="",
                     values = alpha(c(rev(pal_orange), pal_purple), 1)) +
  xlab("") +
  ylab("Number of Sequences") + 
 # scale_x_discrete(labels=c("DVF", "DVF+VS", "DVF+VS+VB", "DVF+VS+VB+VS2",
 #                          "DVF+VS+VB+VS2+addition", "DVF+VS+VB+VS2+addition-removal")) + 
  facet_grid(size_class~seqtype, scales = "free")
```




same idea but with a VS2 base
```{r}
viruses$keep_score_vs2_ntv_all <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_1 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              ntv_1=T, ntv_2=F, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_2 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              ntv_1=F, ntv_2=T, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_3 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              ntv_1=F, ntv_2=F, ntv_3=T, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              ntv_1=F, ntv_2=F, ntv_3=F, ntv_4=T, ntv_5=F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_5 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              ntv_1=F, ntv_2=F, ntv_3=F, ntv_4=F, ntv_5=T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_0 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              ntv_1=F, ntv_2=F, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_0_tv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              ntv_1=F, ntv_2=F, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_all_tv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_all_tv_4_2_1 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=T, tv_2=T, tv_3=F, tv_4=T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_vs2_ntv"), seqtype) %>%
  pivot_longer(cols=contains("keep_score_vs2"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, seqtype) %>%
  summarise(n = n())
```

```{r}
ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_manual(name="",
                     values = alpha(c(rev(pal_orange), pal_purple), 0.7)) +
  xlab("") +
  ylab("Number of Sequences") + 
  facet_grid(~seqtype, scales = "free")
```



comparing each tool's score
```{r}
viruses$keep_score_ind_vs2 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_ind_tv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_ind_dvf <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_ind_vb <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = T,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_ind_ntv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$keep_score_ind_vs <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = T)

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_ind_"), seqtype) %>%
  pivot_longer(cols=contains("keep_score_"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, seqtype) %>%
  summarise(n = n())
```
Fig 4

```{r}
table(viruses$true_virus, viruses$keep_score_ind_dvf)
table(viruses$true_virus, viruses$keep_score_ind_vs2)
table(viruses$true_virus, viruses$keep_score_ind_vs)
table(viruses$true_virus, viruses$keep_score_ind_vb)
```
seems like false positive rate is way high for 0.5 across all

```{r}
table(viruses$true_virus, viruses$keep_score_ind_dvf+viruses$keep_score_ind_vs2)
```

```{r}
table(viruses$true_virus, viruses$keep_score_ind_dvf+viruses$keep_score_ind_vs2+viruses$keep_score_ind_ntv)
```

```{r}
table(viruses$keep_score_ind_vs2, viruses$keep_score_ind_dvf+viruses$keep_score_ind_vs2+viruses$keep_score_ind_ntv)
```
with 0.5 rules: 1464 sequences predicted viral that weren't viral by vs2 on its own
without them: 1234 sequences added

```{r}
table(viruses$keep_score_ind_vs2, viruses$keep_score_ind_dvf+viruses$keep_score_ind_vs2+viruses$keep_score_ind_ntv,
      viruses$true_virus)
```
with 0.5 rules: however, of these, only 432 (30%) are truly viruses
without 0.5 rules: only 375 (30%) are truly viruses

```{r}
table(viruses$keep_score_ind_vs2, viruses$keep_score_ind_vb+viruses$keep_score_ind_vs2+viruses$keep_score_ind_ntv,
      viruses$true_virus)
```
with 0.5 rules: however, of these, only 74 (7%) are truly viruses
without 0.5 rules: only 87 (4%) are truly viruses 


```{r}
pal_purple <- RColorBrewer::brewer.pal(6, "Purples")
pal_orange <- RColorBrewer::brewer.pal(4, "Oranges")

ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom",
    axis.text.x=element_text(size=8, angle = 45)
  ) +
  scale_fill_manual(name="",
                     values = alpha(c(rev(pal_orange), pal_purple), 0.8)) +
  xlab("") +
  ylab("Number of Sequences") + 
  facet_grid(~seqtype, scales = "free") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 2)) +
  scale_x_discrete(labels=rev(c("VirSorter2", "VirSorter", "VIBRANT",
                            "tuning viral", "tuning not viral",
                            "DeepVirFinder")))
```



```{r}
num_high_viruses <- matrix(data=NA, nrow=63, ncol=63)
prop_high_viruses <- matrix(data=NA, nrow=63, ncol=63)

for (i in 1:63) {
  for (j in 1:63) {
    num_high_viruses[i,j] <- sum(viral_scores[,i]>=1 & viral_scores[,j]>=1)
    
    prop_high_viruses[i,j] <- sum(viral_scores[,i]>=1 & viral_scores[,j]>=1)
    prop_high_viruses[i,j] <- prop_high_viruses[i,j]/sum(viral_scores[,i]>=1 | viral_scores[,j]>=1)
  }
}

rownames(num_high_viruses) <- combos_list$toolcombo
colnames(num_high_viruses) <- combos_list$toolcombo

rownames(prop_high_viruses) <- combos_list$toolcombo
colnames(prop_high_viruses) <- combos_list$toolcombo
```

## visualizing a select set of tools
```{r}
viruses$keep_score_high_tv_tnv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)
viruses$keep_score_high_tv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses$tv_vs_tv_ntv <- "not tv"
viruses$tv_vs_tv_ntv[viruses$keep_score_high_tv>=1 & viruses$keep_score_high_tv_tnv>=1] <- "tnv_preserved"
viruses$tv_vs_tv_ntv[viruses$keep_score_high_tv>=1 & viruses$keep_score_high_tv_tnv<1] <- "tnv lost"

table(viruses$tv_vs_tv_ntv, viruses$true_virus)

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_high"), true_virus) %>%
  pivot_longer(cols=contains("keep_score_"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, true_virus) %>%
  summarise(n = n())

pal_purple <- RColorBrewer::brewer.pal(6, "Purples")
pal_orange <- RColorBrewer::brewer.pal(4, "Oranges")

ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_manual(name="",
                     values = alpha(c(rev(pal_orange), pal_purple), 0.8)) +
  xlab("") +
  ylab("Number of Sequences") + 
  facet_grid(~true_virus, scales = "free")
```




# Comparing all of the tool methods - Fig 2A (also needed for 5)
```{r}
combos_list <- data.frame(toolcombo=rep(0, 64),
                          tune_not_viral=rep(0, 64),
                          DVF=rep(0, 64),
                          tune_viral=rep(0, 64),
                          VIBRANT=rep(0, 64),
                          VS=rep(0, 64),
                          VS2=rep(0, 64))
p <- 1

for (i in c(0,1)){
  for (j in c(0,1)){
    for (k in c(0,1)){
      for (l in c(0,1)){
        for (m in c(0,1)){
          for (n in c(0,1)){
            combos_list$toolcombo[p] <- paste(i,j,k,l,m,n)
            combos_list$toolcombo2[p] <- paste(if(i){"tv"}else{"0"},if(j){"DVF"}else{"0"},
                                               if(k){"tnv"}else{"0"},if(l){"VB"}else{"0"},
                                               if(m){"VS"}else{"0"},if(n){"VS2"}else{"0"})
            combos_list$tune_not_viral[p] <- k
            combos_list$DVF[p] <- j
            combos_list$tune_viral[p] <- i
            combos_list$VIBRANT[p] <- l
            combos_list$VS[p] <- m
            combos_list$VS2[p] <- n
            p <- p+1
          }
        }
      }
    }
  }
}

combos_list <- combos_list[-1,]

viral_scores <- matrix(data=0, nrow=nrow(viruses), ncol=nrow(combos_list))
num_viruses <- data.frame(toolcombo=rep(0, nrow(combos_list)),
                          num_viruses=rep(0, nrow(combos_list)))

for (i in 1:nrow(combos_list)) {
  viral_scores[,i] <- getting_viral_set_1(viruses, include_vibrant = combos_list$VIBRANT[i],
                                            include_virsorter = combos_list$VS[i],
                                            include_virsorter2 = combos_list$VS2[i],
                                            include_tuning_viral = combos_list$tune_viral[i],
                                            include_tuning_not_viral = combos_list$tune_not_viral[i],
                                            include_deepvirfinder = combos_list$DVF[i])
  
  if (max(viral_scores[,i])<=0) {
    num_viruses$num_viruses[i] <- 0
  }
  else {
    num_viruses$num_viruses[i] <- table(viral_scores[,i]>=1)[[2]]
  }
  num_viruses$toolcombo[i] <- combos_list$toolcombo[i]
  
  num_viruses$toolcombo2[i] <- combos_list$toolcombo2[i]
}
num_viruses$numtools <- str_count(num_viruses$toolcombo, "1")
num_viruses <- num_viruses[order(num_viruses$num_viruses, decreasing=F),]
num_viruses$toolcombo <- factor(num_viruses$toolcombo, levels = unique(num_viruses$toolcombo))
num_viruses$toolcombo2 <- factor(num_viruses$toolcombo2, levels = unique(num_viruses$toolcombo2))
num_viruses$numtools <- as.factor(num_viruses$numtools)

pal <- ggthemes::tableau_color_pal(palette="Tableau 10", type="regular")
pal2 <- ggthemes::tableau_color_pal(palette="Tableau 20", type="regular")

viruses_1 <- viruses[viruses$Index=="1",]

ann_col = data.frame(
    tnv = combos_list$tune_not_viral,
    tv = combos_list$tune_viral,
    dvf = combos_list$DVF,
    vb = combos_list$VIBRANT,
    vs = combos_list$VS,
    vs2 = combos_list$VS2
)

ann_row = data.frame(
    score = viruses_1$seqtype
)

ann_colors = list(
  tnv = c("black", pal(6)[1]),
  tv = c("black", pal(6)[3]),
  dvf = c("black", pal(6)[2]),
  vb = c("black", pal(6)[4]),
  vs = c("black", pal(6)[5]),
  vs2 = c("black", pal(6)[6]),
  score = c("archaea"=pal2(20)[13], "bacteria"=pal2(20)[9], "fungi"=pal2(20)[20],
              "plasmid"=pal2(20)[19], "protist"=pal2(20)[5], "virus"=pal2(20)[17])
)

rownames(ann_col) <- combos_list$toolcombo
rownames(ann_row) <- viruses_1$contig

viral_scores_1 <- viral_scores[viruses$Index=="1",]

colnames(viral_scores_1) <- combos_list$toolcombo
rownames(viral_scores_1) <- viruses_1$contig

viral_scores_1 <- floor(viral_scores_1)

seq_scores <- rowSums(viral_scores_1)

seq_type <- table(viruses_1$seqtype)[c(6,2,1,4,5,3)]
seq_type <- cumsum(seq_type)

sub_seq_scores <- seq_scores[1:seq_type[1]]
order_seq_scores_virus <- names(sub_seq_scores)[order(sub_seq_scores)]

sub_seq_scores <- seq_scores[seq_type[1]:seq_type[2]]
order_seq_scores_bacteria <- names(sub_seq_scores)[order(sub_seq_scores)]

sub_seq_scores <- seq_scores[seq_type[2]:seq_type[3]]
order_seq_scores_archaea <- names(sub_seq_scores)[order(sub_seq_scores)]

sub_seq_scores <- seq_scores[seq_type[3]:seq_type[4]]
order_seq_scores_plasmid <- names(sub_seq_scores)[order(sub_seq_scores)]

sub_seq_scores <- seq_scores[seq_type[4]:seq_type[5]]
order_seq_scores_protist <- names(sub_seq_scores)[order(sub_seq_scores)]

sub_seq_scores <- seq_scores[seq_type[5]:seq_type[6]]
order_seq_scores_fungi <- names(sub_seq_scores)[order(sub_seq_scores)]

viral_scores_1 <- viral_scores_1[c(order_seq_scores_virus, 
                                   order_seq_scores_bacteria,
                                   order_seq_scores_archaea,
                                   order_seq_scores_plasmid,
                                   order_seq_scores_protist,
                                   order_seq_scores_fungi),]

pheatmap::pheatmap(t(viral_scores_1),
                  annotation_col = ann_row,
                  annotation_row = ann_col,
                  annotation_colors = ann_colors,
                  #border_color = "black",
                  color = c(rev(RColorBrewer::brewer.pal(9,"Oranges")[4:7]),
                            RColorBrewer::brewer.pal(9,"Purples")[4:9] 
                            ),
                  show_rownames = F,
                  show_colnames = F,
                  annotation_legend = F,
                  cluster_rows = F,
                  cluster_cols = F,
                  cellheight=3,
                  gaps_col = c(seq_type[1], seq_type[2], seq_type[3], seq_type[4], seq_type[5]),
                  legend_breaks=c(-3:5),
                  legend_labels=c(-3:5),
                  filename = "../IntermediaryFiles/pheatmap_virus_set_1_viral_scores.png"
                  )
```

# comparing all rules against each other - Figure 5
```{r}
num_high_viruses <- matrix(data=NA, nrow=63, ncol=63)
prop_high_viruses <- matrix(data=NA, nrow=63, ncol=63)

for (i in 1:63) {
  for (j in 1:63) {
    num_high_viruses[i,j] <- sum(viral_scores[,i]>=1 & viral_scores[,j]>=1)
    
    prop_high_viruses[i,j] <- sum(viral_scores[,i]>=1 & viral_scores[,j]>=1)
    prop_high_viruses[i,j] <- prop_high_viruses[i,j]/sum(viral_scores[,i]>=1 | viral_scores[,j]>=1)
  }
}

rownames(num_high_viruses) <- combos_list$toolcombo
colnames(num_high_viruses) <- combos_list$toolcombo

rownames(prop_high_viruses) <- combos_list$toolcombo
colnames(prop_high_viruses) <- combos_list$toolcombo

combos_list$ruletype <- "other"
combos_list$ruletype[combos_list$toolcombo %in% c("0 0 1 0 0 1",
                                          "0 0 1 1 0 0",
                                          "0 0 0 1 0 0")] <- "high precision"
combos_list$ruletype[combos_list$toolcombo %in% c("1 1 0 0 1 1",
                                          "1 1 0 1 1 1",
                                          "1 1 0 0 0 1",
                                          "1 1 0 1 0 1")] <- "high recall"
combos_list$ruletype[combos_list$toolcombo %in% c("0 0 1 0 0 1",
                                          "0 1 1 0 0 1",
                                          "0 0 0 0 0 1",
                                          "1 0 1 1 0 1",
                                          "1 0 1 0 1 1",
                                          "1 0 1 0 0 1")] <- "high MCC"
#combos_lists$ruletype[accuracy_scores$toolcombo %in% c("0 0 1 0 0 1")] <- "high MCC and high precision"
combos_list$ruletype[combos_list$toolcombo %in% c("1 1 1 1 1 1")] <- "all"

combos_list$ruletype <- as.factor(combos_list$ruletype)
```

```{r}
pal <- ggthemes::tableau_color_pal(palette="Tableau 10", type="regular")

ann_col = data.frame(
    tnv = combos_list$tune_not_viral,
    tv = combos_list$tune_viral,
    dvf = combos_list$DVF,
    vb = combos_list$VIBRANT,
    vs = combos_list$VS,
    vs2 = combos_list$VS2,
    ruleset_type = combos_list$ruletype
)

ann_row = data.frame(
    num_vir = colSums(viral_scores>=1)+1)

ann_colors = list(
  num_vir=magma(100),
  tnv = c("black", pal(6)[1]),
  tv = c("black", pal(6)[3]),
  dvf = c("black", pal(6)[2]),
  vb = c("black", pal(6)[4]),
  vs = c("black", pal(6)[5]),
  vs2 = c("black", pal(6)[6]),
  ruleset_type = c("all" = magma(7)[3],
                   "high MCC" = magma(7)[4],
                   "high precision" = magma(7)[5],
                   "high recall" = magma(7)[6], 
                   "other" = "grey")
)

rownames(ann_col) <- combos_list$toolcombo
rownames(ann_row) <- combos_list$toolcombo

pheatmap::pheatmap(prop_high_viruses,
                  annotation_row = ann_row,
                  annotation_col=ann_col,
                  annotation_colors = ann_colors,
                  border_color = "black",
                  color = viridis(100),
                  cutree_rows = 3,
                  cutree_cols = 3,
                  show_rownames = F,
                  show_colnames = F,
                  filename = "../IntermediaryFiles/pheatmap_prop_viruses_in_common.png",
                  annotation_legend = T)

pheatmap::pheatmap(prop_high_viruses,
                  annotation_row = ann_row,
                  annotation_col=ann_col,
                  annotation_colors = ann_colors,
                  border_color = "black",
                  color = c(rep(viridis(3)[1], 5), rep(viridis(3)[2], 4), viridis(3)[3]),
                  cutree_rows = 3,
                  cutree_cols = 3,
                  show_rownames = F,
                  show_colnames = F,
                  filename = "../IntermediaryFiles/pheatmap_prop_viruses_in_common_3_breaks.png",
                  annotation_legend = T)
```




# numbers in common between two tool combos
```{r}
combos_list_two <- combos_list
combos_list_two$numtools <- str_count(combos_list_two$toolcombo, "1")
combos_list_two <- combos_list_two[combos_list_two$numtools==1,]

two_tool_pairs <- num_high_viruses[rownames(num_high_viruses) %in% combos_list_two$toolcombo,
                                   colnames(num_high_viruses) %in% combos_list_two$toolcombo]

colnames(two_tool_pairs) <- c("VS2", "VS", "VB", "tv", "DVF", "tnv")
rownames(two_tool_pairs) <- c("VS2", "VS", "VB", "tv", "DVF", "tnv")
```

```{r}
viral_scores_two <- viral_scores[,colnames(num_high_viruses) %in% combos_list_two$toolcombo]

n <- 6
viral_scores_two_comb <- matrix(data=NA, nrow=n, ncol=n)

for (i in 1:n) {
  for (j in 1:n) {
    if (i==j) {
      viral_scores_two_comb[i,j] <- sum(viral_scores_two[,i]>=1)
    }
    else if (i<j) {
      viral_scores_two_comb[i,j] <- sum((viral_scores_two[,i]+viral_scores_two[,j])>=1)
    }
    else if (i>j) {
      viral_scores_two_comb[i,j] <- paste(round(sum((viral_scores_two[,i]+viral_scores_two[,j])>=1)/sum(viral_scores_two[,i]>=1 | viral_scores_two[,j]>=1)*100, digits=0), "%", sep="")
    }
  }
}

colnames(viral_scores_two_comb) <- c("VS2", "VS", "VB", "tv", "DVF", "tnv")
rownames(viral_scores_two_comb) <- c("VS2", "VS", "VB", "tv", "DVF", "tnv")
```


```{r}
viral_scores_two_comb
```

comparing VS2 and VIBRANT viruses - Figure S15
```{r}
vs2_vb <- data.frame(vs2=viral_scores_two[,1],
                     vb=viral_scores_two[,3],
                     comb_score=viral_scores_two[,1]+viral_scores_two[,3],
                     seqtype=viruses$seqtype,
                     max_score_group=viruses$max_score_group)

vs2_vb$comb[vs2_vb$comb_score<1] <- "neither"
vs2_vb$comb[vs2_vb$vs2==0.5 & vs2_vb$vb==0.5] <- "both_low"
vs2_vb$comb[vs2_vb$vs2>=1 & vs2_vb$vb==0.5] <- "vs2_high_vb_low"
vs2_vb$comb[vs2_vb$vs2>=0.5 & vs2_vb$vb==1] <- "vs2_low_vb_high"
vs2_vb$comb[vs2_vb$vs2>=1 & vs2_vb$vb==0] <- "vs2_only"
vs2_vb$comb[vs2_vb$vs2==0 & vs2_vb$vb>=1] <- "vb_only"
vs2_vb$comb[vs2_vb$vs2>=1 & vs2_vb$vb>=1] <- "both_high"

#vs2_vb$true_virus <- "not"
#vs2_vb$true_virus[vs2_vb$seqtype=="virus"] <- "virus"

vs2_vb_seqtype <- vs2_vb %>% 
  group_by(comb, comb_score, seqtype) %>%
  summarise(n = n())
```

```{r}
table(vs2_vb$comb)
```

```{r}
ggplot(vs2_vb_seqtype, aes(y=n, x=comb,
                   fill=as.factor(comb_score))) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_brewer(palette = "PuOr", ) +
  xlab("") +
  ylab("Number of Sequences") + 
  facet_grid(~seqtype, scales = "free")
```

# overlap in proportion of contigs for tool sets - Figure S16

get number of tools and number of rules for each combination
```{r}
ann_col$numrules <- rowSums(ann_col[,1:6])
ann_col$numtools <- ann_col$numrules

for (i in 1:nrow(ann_col)) {
  if (ann_col$tv[i]==1) {
    ann_col$numtools[i] <- ann_col$numtools[i] + 3
  }
  
  if (ann_col$tnv[i]==1) {
    ann_col$numtools[i] <- ann_col$numtools[i] + 5
  }
}

ann_col$numtools[ann_col$numtools>6] <- 6

ann_col$tool <- rownames(ann_col)
```

```{r}
prop_high_viruses_long <- as.data.frame(prop_high_viruses)
prop_high_viruses_long$tool <- combos_list$toolcombo

prop_high_viruses_long <- as.data.frame(prop_high_viruses_long) %>% 
  pivot_longer(!tool,
               values_to="proportion",
               names_to="tool2") %>%
  inner_join(ann_col, by=c("tool"))


```

```{r}
head(prop_high_viruses_long)
```


```{r}
ggplot(prop_high_viruses_long[prop_high_viruses_long$vs2==1,], aes(x=as.factor(numrules), y=proportion, 
                                  color=as.factor(numrules), fill=as.factor(numrules))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Rules") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(rev(viridis(6)), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(rev(viridis(6)), 0.7))

ggplot(prop_high_viruses_long[prop_high_viruses_long$vs==1,], aes(x=as.factor(numrules), y=proportion, 
                                  color=as.factor(numrules), fill=as.factor(numrules))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Rules") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(rev(viridis(6)), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(rev(viridis(6)), 0.7))

ggplot(prop_high_viruses_long[prop_high_viruses_long$vb==1,], aes(x=as.factor(numrules), y=proportion, 
                                  color=as.factor(numrules), fill=as.factor(numrules))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Rules") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(rev(viridis(6)), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(rev(viridis(6)), 0.7))

ggplot(prop_high_viruses_long[prop_high_viruses_long$dvf==1,], aes(x=as.factor(numrules), y=proportion, 
                                  color=as.factor(numrules), fill=as.factor(numrules))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Rules") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(rev(viridis(6)), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(rev(viridis(6)), 0.7))
```

# Comparing RefSeq vs VS2 database
VS2 sequences used: (/scratch/kwigg_root/kwigg/hegartyb/VSTE/non-refseq-genomes/NCLDV/env/NCLDV_env.fna /scratch/kwigg_root/kwigg/hegartyb/VSTE/non-refseq-genomes/lavidaviridae/env/HQ_virophages.fna /scratch/kwigg_root/kwigg/hegartyb/VSTE/non-refseq-genomes/dsDNAphage/env/* /scratch/kwigg_root/kwigg/hegartyb/VSTE/non-refseq-genomes/dsDNAphage/provirus/VirSorterCuratedDataset_HQ_contigs.fna)

```{r}
refseq_vir <- read_tsv("../IntermediaryFiles/refseq_viral_genome_ids.txt",col_names = F)
refseq_vir$X1 <- sub(">", "", refseq_vir$X1)
refseq_vir <- separate(refseq_vir, col=X1, sep=" ", remove=T, into="id")
refseq_vir$id <- sub("\\.", "_", refseq_vir$id)
```

```{r}
table(refseq_vir$id %in% viruses$contig)
```

```{r}
viruses_refseq_vir <- viruses[viruses$contig %in% refseq_vir$id,]
viruses_not_refseq_vir <- viruses[!(viruses$contig %in% refseq_vir$id) & viruses$seqtype=="virus",]
```

```{r}
table(viruses_refseq_vir$max_score_group)
table(viruses_not_refseq_vir$max_score_group)
```

```{r}
viruses_refseq_vir$keep_score_high_MCC <- getting_viral_set_1(viruses_refseq_vir, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses_not_refseq_vir$keep_score_high_MCC <- getting_viral_set_1(viruses_not_refseq_vir, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)
```


```{r}
sum(viruses_refseq_vir$keep_score_high_MCC>=1)/nrow(viruses_refseq_vir)
```

```{r}
sum(viruses_not_refseq_vir$keep_score_high_MCC>=1)/nrow(viruses_not_refseq_vir)
```




