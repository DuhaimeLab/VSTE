---
title: "VSTE - Comparing Methods Visualization"
author: Bridget Hegarty, James Riddell
date: 07-22-2022
output: html_notebook
---
This Rmarkdown file assesses the output of CheckV, DeepVirFinder, Kaiju,
VIBRANT, VirSorter, and VirSorter2 on multiple training sets of microbial DNA, 
primarily from NCBI. Created from fungal, viral, bacterial, archeael, protist,
and plasmid DNA sequences

Please reach out to James Riddell (riddell.26@buckeyemail.osu.edu) or
Bridget Hegarty (beh53@case.edu) regarding any issues, or open an issue on github.

```{r setup-library}
library(ggplot2)
library(plyr)
library(reshape2)
library(viridis)
library(tidyr)
library(dplyr)
library(readr)
library(data.table)
library("stringr")
```

Import the file that combines the results from each of the tools from running "combining_tool_output.Rmd":
```{r}
viruses <- read_tsv("../IntermediaryFiles/viral_tools_combined.tsv")
```

This section defines a viralness score "keep_score" based on the tool classifications. 
A final keep_score above 1 indicates we will keep that sequence and call it viral.

VIBRANT
    Quality == "Complete Circular": +1
    Quality == "High Quality Draft": +1
    Quality == "Medium Quality Draft": +1
    Quality == "Low Quality Draft" & provirus: +0.5

Virsorter2
    Viral >= 50: +0.5
    Viral >= 0.95: +0.5
    RNA >= 0.9: +1
    lavidaviridae >= 0.9: +1
    NCLDV >= 0.9: +1

Virsorter
    category ==  1,4: +1
    category == 2,5: +0.5

DeepVirFinder:
    Score >= 0.7: +0.5

Tuning - No Viral Signature:
    Kaiju_viral = "cellular organisms": -0.5
    If host_genes >50 and NOT provirus: -1 
    If viral_genes == 0 and host_genes >= 1: -1
    If 3*viral_genes <= host_genes and NOT provirus: -1
    If length > 50,000 and hallmark <=1: -1
    If length < 5000 and checkv completeness <= 75: -0.5

Tuning - Viral Signature:
    Kaiju_viral = "Viruses": +1
    If %unknown >= 75 and length < 50000: +0.5
    If %viral >= 50: +0.5
    Hallmark > 2: +1
    

This script produces visualizations of these combined viral scorings and
includes ecological metrics like alpha diversity.

You can decide which combination is appropriate for them and only need use the
tools appropriate for your data.

```{r getting_viral_set_1}
getting_viral_set_1 <- function(input_seqs,
                                include_vibrant=FALSE, 
                                include_virsorter2=FALSE,
                                include_deepvirfinder=FALSE,
                                include_tuning_viral=FALSE,
                                include_tuning_not_viral=FALSE,
                                include_virsorter=FALSE) {
  
  keep_score <- rep(0, nrow(input_seqs))

  if (include_vibrant) {
    keep_score[input_seqs$vibrant_quality=="high quality draft"] <- keep_score[input_seqs$vibrant_quality=="high quality draft"] + 1
    keep_score[input_seqs$vibrant_quality=="medium quality draft"] <- keep_score[input_seqs$vibrant_quality=="medium quality draft"] + 1
    keep_score[input_seqs$vibrant_quality=="low quality draft" & input_seqs$provirus] <- keep_score[input_seqs$vibrant_quality=="low quality draft" & input_seqs$provirus] + 0.5
  }
  
  if (include_virsorter2) {
    keep_score[input_seqs$max_score>=0.50] <- keep_score[input_seqs$max_score>=0.50] + 0.5
    keep_score[input_seqs$max_score>=0.95] <- keep_score[input_seqs$max_score>=0.95] + 0.5  
  }
  
  if (include_virsorter) {
    keep_score[input_seqs$category==1] <- keep_score[input_seqs$category==1] + 1
    keep_score[input_seqs$category==2] <- keep_score[input_seqs$category==2] + 0.5
    keep_score[input_seqs$category==3] <- keep_score[input_seqs$category==3] + 0.5
    keep_score[input_seqs$category==4] <- keep_score[input_seqs$category==4] + 1
    keep_score[input_seqs$category==5] <- keep_score[input_seqs$category==5] + 0.5 
    keep_score[input_seqs$category==6] <- keep_score[input_seqs$category==6] + 0.5 
  }
  
  if (include_deepvirfinder) {
     # add if DVF calls viral
    keep_score[(input_seqs$score>=0.9 & input_seqs$pvalue<=0.05) & input_seqs$checkv_length<20000] <- keep_score[input_seqs$score>=0.9 & input_seqs$checkv_length<20000] + 0.5
    keep_score[(input_seqs$score>=0.7 & input_seqs$pvalue<=0.05) & input_seqs$checkv_length<20000] <- keep_score[input_seqs$score>=0.7 & input_seqs$checkv_length<20000] + 0.5
  }
  
  if (include_tuning_viral) {
  # tuning addition
    keep_score[input_seqs$hallmark>2] <- keep_score[input_seqs$hallmark>2] + 1
    keep_score[input_seqs$Kaiju_Viral=="Viruses"] <- keep_score[input_seqs$Kaiju_Viral=="Viruses"] + 1
    #note: had tried pulling out this rule, but better recall without sacrificing precision with it in
    #note: having kaiju removal rule didn't help
    keep_score[input_seqs$percent_unknown>=75 & input_seqs$checkv_length<50000] <- keep_score[input_seqs$percent_unknown>=75 & input_seqs$checkv_length<50000] + 0.5
    keep_score[input_seqs$viral>=50 | input_seqs$percent_viral>=50] <- keep_score[input_seqs$viral>=50 | input_seqs$percent_viral>=50] + 0.5 
    keep_score[(input_seqs$checkv_completeness>=75 | input_seqs$vibrant_quality=="complete circular") & (input_seqs$viral>=50 | input_seqs$percent_viral>=50)] <- keep_score[(input_seqs$checkv_completeness>=75 | input_seqs$vibrant_quality=="complete circular") & (input_seqs$viral>=50 | input_seqs$percent_viral>=50)] + 0.5 
  }
  
  if (include_tuning_not_viral) {
    # tuning removal 
    keep_score[input_seqs$checkv_host_genes>50 & !input_seqs$provirus] <- 0
    keep_score[input_seqs$checkv_viral_genes==0 & input_seqs$checkv_host_genes>=1] <- keep_score[input_seqs$checkv_viral_genes==0 & input_seqs$checkv_host_genes>=1] - 1
    keep_score[((input_seqs$checkv_viral_genes*3) <= input_seqs$checkv_host_genes) & !input_seqs$provirus] <- keep_score[((input_seqs$checkv_viral_genes*3) <= input_seqs$checkv_host_genes) & !input_seqs$provirus] - 1 
    keep_score[input_seqs$checkv_length>500000 & input_seqs$hallmark<=1] <- 0
    keep_score[(input_seqs$checkv_completeness<=75) & input_seqs$checkv_length<=5000] <- keep_score[(input_seqs$checkv_completeness<=75) & input_seqs$checkv_length<=5000] - 0.5 
    # remove if DVF calls it not viral
    keep_score[input_seqs$score<=0.7 & input_seqs$pvalue<=0.05] <- keep_score[input_seqs$score<=0.7 & input_seqs$pvalue<=0.05] - 1
   
  }
  
  return(keep_score)
  
}
```

# Comparing all of the tool methods

```{r}
combos_list <- data.frame(toolcombo=rep(0, 64),
                          tune_not_viral=rep(0, 64),
                          DVF=rep(0, 64),
                          tune_viral=rep(0, 64),
                          VIBRANT=rep(0, 64),
                          VS=rep(0, 64),
                          VS2=rep(0, 64))
p <- 1

for (i in c(0,1)){
  for (j in c(0,1)){
    for (k in c(0,1)){
      for (l in c(0,1)){
        for (m in c(0,1)){
          for (n in c(0,1)){
            combos_list$toolcombo[p] <- paste(i,j,k,l,m,n)
            combos_list$toolcombo2[p] <- paste(if(i){"tnv"}else{"0"},if(j){"DVF"}else{"0"},
                                               if(k){"tv"}else{"0"},if(l){"VB"}else{"0"},
                                               if(m){"VS"}else{"0"},if(n){"VS2"}else{"0"})
            combos_list$tune_not_viral[p] <- i
            combos_list$DVF[p] <- j
            combos_list$tune_viral[p] <- k
            combos_list$VIBRANT[p] <- l
            combos_list$VS[p] <- m
            combos_list$VS2[p] <- n
            p <- p+1
          }
        }
      }
    }
  }
}

combos_list <- combos_list[-1,]
```

```{r}
viral_scores <- matrix(data=0, nrow=nrow(viruses), ncol=nrow(combos_list))
num_viruses <- data.frame(toolcombo=rep(0, nrow(combos_list)),
                          num_viruses=rep(0, nrow(combos_list)))
for (i in 1:nrow(combos_list)) {
  viral_scores[,i] <- getting_viral_set_1(viruses, include_vibrant = combos_list$VIBRANT[i],
                                            include_virsorter = combos_list$VS[i],
                                            include_virsorter2 = combos_list$VS2[i],
                                            include_tuning_viral = combos_list$tune_viral[i],
                                            include_tuning_not_viral = combos_list$tune_not_viral[i],
                                            include_deepvirfinder = combos_list$DVF[i])
  
  if (max(viral_scores[,i])<=0) {
    num_viruses$num_viruses[i] <- 0
  }
  else {
    num_viruses$num_viruses[i] <- table(viral_scores[,i]>=1)[[2]]
  }
  num_viruses$toolcombo[i] <- combos_list$toolcombo[i]
  
  num_viruses$toolcombo2[i] <- combos_list$toolcombo2[i]
}
num_viruses$numtools <- str_count(num_viruses$toolcombo, "1")
num_viruses <- num_viruses[order(num_viruses$num_viruses, decreasing=F),]
num_viruses$toolcombo <- factor(num_viruses$toolcombo, levels = unique(num_viruses$toolcombo))
num_viruses$toolcombo2 <- factor(num_viruses$toolcombo2, levels = unique(num_viruses$toolcombo2))
num_viruses$numtools <- as.factor(num_viruses$numtools)
```

```{r}
dim(viral_scores)
```

```{r}
pal <- ggthemes::tableau_color_pal(palette="Tableau 10", type="regular")

viruses_1 <- viruses[viruses$Index=="1",]

ann_col = data.frame(
    tnv = combos_list$tune_not_viral,
    tv = combos_list$tune_viral,
    dvf = combos_list$DVF,
    vb = combos_list$VIBRANT,
    vs = combos_list$VS,
    vs2 = combos_list$VS2
)

ann_row = data.frame(
    seqtype = viruses_1$seqtype
)

ann_colors = list(
  tnv = c("black", pal(6)[1]),
  tv = c("black", pal(6)[3]),
  dvf = c("black", pal(6)[2]),
  vb = c("black", pal(6)[4]),
  vs = c("black", pal(6)[5]),
  vs2 = c("black", pal(6)[6]),
  seqtype = c("archaea"=pal(6)[1], "bacteria"=pal(6)[2], "fungi"=pal(6)[3],
              "plasmid"=pal(6)[4], "protist"=pal(6)[5], "virus"=pal(6)[6])
)

rownames(ann_col) <- combos_list$toolcombo
rownames(ann_row) <- viruses_1$contig

viral_scores_1 <- viral_scores[viruses$Index=="1",]

colnames(viral_scores_1) <- combos_list$toolcombo
rownames(viral_scores_1) <- viruses_1$contig
```

```{r}
pheatmap::pheatmap(t(viral_scores_1[(viruses_1$seqtype=="virus"),]),
                  annotation_row = ann_col,
                  annotation_colors = ann_colors,
                  #border_color = "black",
                  color = c(rev(RColorBrewer::brewer.pal(3,"Oranges")),
                            RColorBrewer::brewer.pal(5,"Purples") 
                            ),
                  show_rownames = F,
                  show_colnames = F,
                  annotation_legend = F,
                  cluster_rows=F#,
                 # filename = "../IntermediaryFiles/pheatmap_virus_set_1_viral_scores.png"
                  )
```

```{r}
pheatmap::pheatmap(t(viral_scores_1[(viruses_1$seqtype=="bacteria"),]),
                  annotation_row = ann_col,
                  annotation_colors = ann_colors,
                  #border_color = "black",
                  color = c(rev(RColorBrewer::brewer.pal(5,"Oranges")),
                            RColorBrewer::brewer.pal(4,"Purples") 
                            ),
                  show_rownames = F,
                  show_colnames = F,
                  annotation_legend = F,
                  cluster_rows=F#,
                 # filename = "../IntermediaryFiles/pheatmap_virus_set_1_viral_scores.png"
                  )
```

```{r}
pheatmap::pheatmap(t(viral_scores_1),
                  annotation_col = ann_row,
                  annotation_row = ann_col,
                  annotation_colors = ann_colors,
                  #border_color = "black",
                  color = c(rev(RColorBrewer::brewer.pal(5,"Oranges")),
                            RColorBrewer::brewer.pal(5,"Purples") 
                            ),
                  show_rownames = F,
                  show_colnames = F,
                  annotation_legend = F,
                  cluster_rows = F,
                  cluster_cols = F#,
                 # filename = "../IntermediaryFiles/pheatmap_virus_set_1_viral_scores.png"
                  )
```


##matrix of number in agreement between tools
### number predicted together
```{r}
num_high_viruses <- matrix(data=NA, nrow=63, ncol=63)

for (i in 1:63) {
  for (j in 1:63) {
    num_high_viruses[i,j] <- sum(viral_scores[,i]>=1 & viral_scores[,j]>=1)
  }
}

rownames(num_high_viruses) <- combos_list$toolcombo
colnames(num_high_viruses) <- combos_list$toolcombo

prop_high_viruses <- matrix(data=NA, nrow=63, ncol=63)

for (i in 1:63) {
  for (j in 1:63) {
    prop_high_viruses[i,j] <- sum(viral_scores[,i]>=1 & viral_scores[,j]>=1)
    prop_high_viruses[i,j] <- prop_high_viruses[i,j]/sum(viral_scores[,i]>=1 | viral_scores[,j]>=1)
  }
}

rownames(prop_high_viruses) <- combos_list$toolcombo
colnames(prop_high_viruses) <- combos_list$toolcombo
```

```{r}
pal <- ggthemes::tableau_color_pal(palette="Tableau 10", type="regular")

ann_col = data.frame(
    tnv = combos_list$tune_not_viral,
    tv = combos_list$tune_viral,
    dvf = combos_list$DVF,
    vb = combos_list$VIBRANT,
    vs = combos_list$VS,
    vs2 = combos_list$VS2,
    num_vir = colSums(viral_scores>=1)+1
)

ann_colors = list(
  num_vir=magma(100),
  tnv = c("black", pal(6)[1]),
  tv = c("black", pal(6)[3]),
  dvf = c("black", pal(6)[2]),
  vb = c("black", pal(6)[4]),
  vs = c("black", pal(6)[5]),
  vs2 = c("black", pal(6)[6])
)

rownames(ann_col) <- combos_list$toolcombo

pheatmap::pheatmap(num_high_viruses,
                  annotation_row = ann_col,
                  annotation_colors = ann_colors,
                  border_color = "black",
                  color = magma(100),
                  cutree_rows = 4,
                  cutree_cols = 4,
                  show_rownames = F,
                  filename = "../IntermediaryFiles/pheatmap_num_viruses_in_common.png",
                  annotation_legend = F)
```

```{r}
pal <- ggthemes::tableau_color_pal(palette="Tableau 10", type="regular")

ann_col = data.frame(
    tnv = combos_list$tune_not_viral,
    tv = combos_list$tune_viral,
    dvf = combos_list$DVF,
    vb = combos_list$VIBRANT,
    vs = combos_list$VS,
    vs2 = combos_list$VS2,
    num_vir = colSums(viral_scores>=1)+1
)

ann_colors = list(
  num_vir=magma(100),
  tnv = c("black", pal(6)[1]),
  tv = c("black", pal(6)[3]),
  dvf = c("black", pal(6)[2]),
  vb = c("black", pal(6)[4]),
  vs = c("black", pal(6)[5]),
  vs2 = c("black", pal(6)[6])
)

rownames(ann_col) <- combos_list$toolcombo

pheatmap::pheatmap(prop_high_viruses,
                  annotation_row = ann_col,
                  annotation_colors = ann_colors,
                  border_color = "black",
                  color = viridis(100),
                  cutree_rows = 4,
                  cutree_cols = 4,
                  show_rownames = F,
                  filename = "../IntermediaryFiles/pheatmap_prop_viruses_in_common.png",
                  annotation_legend = F)
```

# overlap in proportion of contigs for tool sets

get number of tools and number of rules for each combination
```{r}
ann_col$numrules <- rowSums(ann_col[,1:6])
ann_col$numtools <- ann_col$numrules

for (i in 1:nrow(ann_col)) {
  if (ann_col$tv[i]==1) {
    ann_col$numtools[i] <- ann_col$numtools[i] + 3
  }
  
  if (ann_col$tnv[i]==1) {
    ann_col$numtools[i] <- ann_col$numtools[i] + 5
  }
}

ann_col$numtools[ann_col$numtools>6] <- 6

ann_col$tool <- rownames(ann_col)
```

```{r}
prop_high_viruses_long <- as.data.frame(prop_high_viruses)
prop_high_viruses_long$tool <- combos_list$toolcombo

prop_high_viruses_long <- as.data.frame(prop_high_viruses_long) %>% 
  pivot_longer(!tool,
               values_to="proportion",
               names_to="tool2") %>%
  inner_join(ann_col, by=c("tool"))


```

```{r}
head(prop_high_viruses_long)
```


```{r}
ggplot(prop_high_viruses_long[prop_high_viruses_long$vs2==1,], aes(x=as.factor(numrules), y=proportion, 
                                  color=as.factor(numrules), fill=as.factor(numrules))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Rules") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(rev(pal(6)), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(rev(pal(6)), 0.7))

ggplot(prop_high_viruses_long[prop_high_viruses_long$vs==1,], aes(x=as.factor(numrules), y=proportion, 
                                  color=as.factor(numrules), fill=as.factor(numrules))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Rules") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(rev(pal(6)), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(rev(pal(6)), 0.7))

ggplot(prop_high_viruses_long[prop_high_viruses_long$vb==1,], aes(x=as.factor(numrules), y=proportion, 
                                  color=as.factor(numrules), fill=as.factor(numrules))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Rules") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(rev(pal(6)), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(rev(pal(6)), 0.7))

ggplot(prop_high_viruses_long[prop_high_viruses_long$dvf==1,], aes(x=as.factor(numrules), y=proportion, 
                                  color=as.factor(numrules), fill=as.factor(numrules))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Rules") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(rev(pal(6)), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(rev(pal(6)), 0.7))
```

```{r}
table(prop_high_viruses_long$numrules[prop_high_viruses_long$dvf==1])

```


```{r}
ggplot(prop_high_viruses_long[prop_high_viruses_long$vs2==1,], aes(x=as.factor(numtools), y=proportion, 
                                  color=as.factor(numtools), fill=as.factor(numtools))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Tools") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(pal(6), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(pal(6), 0.7))

ggplot(prop_high_viruses_long[prop_high_viruses_long$vs==1,], aes(x=as.factor(numtools), y=proportion, 
                                  color=as.factor(numtools), fill=as.factor(numtools))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Tools") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(pal(6), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(pal(6), 0.7))

ggplot(prop_high_viruses_long[prop_high_viruses_long$vb==1,], aes(x=as.factor(numtools), y=proportion, 
                                  color=as.factor(numtools), fill=as.factor(numtools))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Tools") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(pal(6), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(pal(6), 0.7))

ggplot(prop_high_viruses_long[prop_high_viruses_long$dvf==1,], aes(x=as.factor(numtools), y=proportion, 
                                  color=as.factor(numtools), fill=as.factor(numtools))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Tools") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(pal(6), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(pal(6), 0.7))
```
rather than tool against all others, ones against ones, twos against twos...

```{r}
prop_high_viruses_long$numrules2 <- str_count(prop_high_viruses_long$tool, "1")

# accounting for rules that have multiple tools in them
prop_high_viruses_long$numtools2 <- prop_high_viruses_long$numrules2

prop_high_viruses_long$numtoolscommon <- 0

for (i in 1:nrow(prop_high_viruses_long)) {
  toolcombo <- as.character(prop_high_viruses_long$tool[i])
  if (substr(toolcombo, 1, 1)=="1") {
    prop_high_viruses_long$numtools2[i] <- prop_high_viruses_long$numtools2[i] + 3
  }
  
  if (substr(toolcombo, 5, 5)=="1") {
    prop_high_viruses_long$numtools2[i] <- prop_high_viruses_long$numtools2[i] + 4
  }
  
  if (prop_high_viruses_long$numtools2[i]==prop_high_viruses_long$numrules2[i]) {
    prop_high_viruses_long$numtoolscommon[i] <- prop_high_viruses_long$numtools2[i] 
  }
  
}

# can't actually have more than 6 tools
prop_high_viruses_long$numtools2[prop_high_viruses_long$numtools2>6] <- 6





prop_high_viruses_long$numrules2 <- as.factor(prop_high_viruses_long$numrules2)
prop_high_viruses_long$numtools2 <- as.factor(prop_high_viruses_long$numtools2)
prop_high_viruses_long$numtoolscommon <- as.factor(prop_high_viruses_long$numtoolscommon)
```

```{r}
ggplot(prop_high_viruses_long[prop_high_viruses_long$vs2==1,], aes(x=as.factor(numtoolscommon), y=proportion, 
                                  color=as.factor(numtoolscommon), fill=as.factor(numtoolscommon))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Tools") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(pal(6), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(pal(6), 0.7))

ggplot(prop_high_viruses_long[prop_high_viruses_long$vs==1,], aes(x=as.factor(numtoolscommon), y=proportion, 
                                  color=as.factor(numtoolscommon), fill=as.factor(numtoolscommon))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Tools") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(pal(6), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(pal(6), 0.7))

ggplot(prop_high_viruses_long[prop_high_viruses_long$vb==1,], aes(x=as.factor(numtoolscommon), y=proportion, 
                                  color=as.factor(numtoolscommon), fill=as.factor(numtoolscommon))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Tools") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(pal(6), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(pal(6), 0.7))

ggplot(prop_high_viruses_long[prop_high_viruses_long$dvf==1,], aes(x=as.factor(numtoolscommon), y=proportion, 
                                  color=as.factor(numtoolscommon), fill=as.factor(numtoolscommon))) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Number of Tools") +
  ylab("Proportion of Contigs in Common") +
  scale_fill_manual(name="",
                     values = alpha(pal(6), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(pal(6), 0.7))
```








# distribution of proportion in common for each pair

```{r}
prop_high_viruses_long <- as.data.frame(prop_high_viruses)
prop_high_viruses_long$tool <- combos_list$toolcombo

prop_high_viruses_long <- as.data.frame(prop_high_viruses_long) %>% 
  pivot_longer(!tool,
               values_to="proportion",
               names_to="tool2") 

prop_high_viruses_long$binned_prop <- "0-10%"
prop_high_viruses_long$binned_prop[prop_high_viruses_long$proportion>=0.10] <- "10-50%"
prop_high_viruses_long$binned_prop[prop_high_viruses_long$proportion>=0.50] <- "50-90%"
prop_high_viruses_long$binned_prop[prop_high_viruses_long$proportion>=0.90] <- "90-100%"


```

```{r}
table(prop_high_viruses_long$binned_prop)
```

```{r}
prop_high_viruses_long$toolcombo <- paste(prop_high_viruses_long$tool,
                                          prop_high_viruses_long$tool2,
                                          sep="-")
prop_high_viruses_long$toolcombo <- gsub(" ", "", prop_high_viruses_long$toolcombo)
prop_high_viruses_long$toolcombo <- unique(prop_high_viruses_long$toolcombo)
```


```{r}
head(prop_high_viruses_long)
```


```{r}
hist(prop_high_viruses_long$proportion)
```

# numbers in common between two tool combos
```{r}
combos_list_two <- combos_list
combos_list_two$numtools <- str_count(combos_list_two$toolcombo, "1")
combos_list_two <- combos_list_two[combos_list_two$numtools==1,]

two_tool_pairs <- num_high_viruses[rownames(num_high_viruses) %in% combos_list_two$toolcombo,
                                   colnames(num_high_viruses) %in% combos_list_two$toolcombo]

colnames(two_tool_pairs) <- c("VS2", "VS", "VB", "tv", "DVF", "tnv")
rownames(two_tool_pairs) <- c("VS2", "VS", "VB", "tv", "DVF", "tnv")
```

```{r}
viral_scores_two <- viral_scores[,colnames(num_high_viruses) %in% combos_list_two$toolcombo]

n <- 6
viral_scores_two_comb <- matrix(data=NA, nrow=n, ncol=n)

for (i in 1:n) {
  for (j in 1:n) {
    if (i==j) {
      viral_scores_two_comb[i,j] <- sum(viral_scores_two[,i]>=1)
    }
    else if (i<j) {
      viral_scores_two_comb[i,j] <- sum((viral_scores_two[,i]+viral_scores_two[,j])>=1)
    }
    else if (i>j) {
      viral_scores_two_comb[i,j] <- paste(round(sum((viral_scores_two[,i]+viral_scores_two[,j])>=1)/sum(viral_scores_two[,i]>=1 | viral_scores_two[,j]>=1)*100, digits=0), "%", sep="")
    }
  }
}

colnames(viral_scores_two_comb) <- c("VS2", "VS", "VB", "tv", "DVF", "tnv")
rownames(viral_scores_two_comb) <- c("VS2", "VS", "VB", "tv", "DVF", "tnv")
```



# Comparing RefSeq vs VS2 database
VS2 sequences used: (/scratch/kwigg_root/kwigg/hegartyb/VSTE/non-refseq-genomes/NCLDV/env/NCLDV_env.fna /scratch/kwigg_root/kwigg/hegartyb/VSTE/non-refseq-genomes/lavidaviridae/env/HQ_virophages.fna /scratch/kwigg_root/kwigg/hegartyb/VSTE/non-refseq-genomes/dsDNAphage/env/* /scratch/kwigg_root/kwigg/hegartyb/VSTE/non-refseq-genomes/dsDNAphage/provirus/VirSorterCuratedDataset_HQ_contigs.fna)

```{r}
refseq_vir <- read_tsv("../IntermediaryFiles/refseq_viral_genome_ids.txt",col_names = F)
refseq_vir$X1 <- sub(">", "", refseq_vir$X1)
refseq_vir <- separate(refseq_vir, col=X1, sep=" ", remove=T, into="id")
refseq_vir$id <- sub("\\.", "_", refseq_vir$id)
```

```{r}
table(refseq_vir$id %in% viruses$contig)
```

```{r}
viruses_refseq_vir <- viruses[viruses$contig %in% refseq_vir$id,]
viruses_not_refseq_vir <- viruses[!(viruses$contig %in% refseq_vir$id) & viruses$seqtype=="virus",]
```

```{r}
table(viruses_refseq_vir$max_score_group)
table(viruses_not_refseq_vir$max_score_group)
```
recall
```{r}
length(grep("true positive", viruses_refseq_vir$confusion_matrix_high_MCC))/nrow(viruses_refseq_vir)
```

```{r}
length(grep("true positive", viruses_not_refseq_vir$confusion_matrix_high_MCC))/nrow(viruses_not_refseq_vir)
```






