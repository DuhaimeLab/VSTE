---
title: "VSTE - Comparing Methods Visualization"
author: Bridget Hegarty, James Riddell
date: 07-22-2022
output: html_notebook
---
This Rmarkdown file assesses the output of CheckV, DeepVirFinder, Kaiju,
VIBRANT, VirSorter, and VirSorter2 on multiple training sets of microbial DNA, 
primarily from NCBI. Created from fungal, viral, bacterial, archeael, protist,
and plasmid DNA sequences

Please reach out to James Riddell (riddell.26@buckeyemail.osu.edu) or
Bridget Hegarty (beh53@case.edu) regarding any issues, or open an issue on github.

```{r setup-library}
library(ggplot2)
library(plyr)
library(reshape2)
library(viridis)
library(tidyr)
library(dplyr)
library(readr)
library(data.table)
library("stringr")
```

Import the file that combines the results from each of the tools from running "combining_tool_output.Rmd":
```{r}
viruses <- read_tsv("../IntermediaryFiles/viral_tools_combined.tsv")
```

This section defines a viralness score "keep_score" based on the tool classifications. 
A final keep_score above 1 indicates we will keep that sequence and call it viral.

VIBRANT
    Quality == "Complete Circular": +1
    Quality == "High Quality Draft": +1
    Quality == "Medium Quality Draft": +1
    Quality == "Low Quality Draft" & provirus: +0.5

Virsorter2
    Viral >= 50: +0.5
    Viral >= 0.95: +0.5
    RNA >= 0.9: +1
    lavidaviridae >= 0.9: +1
    NCLDV >= 0.9: +1

Virsorter
    category ==  1,4: +1
    category == 2,5: +0.5

DeepVirFinder:
    Score >= 0.7: +0.5

Tuning - No Viral Signature:
    Kaiju_viral = "cellular organisms": -0.5
    If host_genes >50 and NOT provirus: -1 
    If viral_genes == 0 and host_genes >= 1: -1
    If 3*viral_genes <= host_genes and NOT provirus: -1
    If length > 50,000 and hallmark <=1: -1
    If length < 5000 and checkv completeness <= 75: -0.5

Tuning - Viral Signature:
    Kaiju_viral = "Viruses": +1
    If %unknown >= 75 and length < 50000: +0.5
    If %viral >= 50: +0.5
    Hallmark > 2: +1
    

This script produces visualizations of these combined viral scorings and
includes ecological metrics like alpha diversity.

You can decide which combination is appropriate for them and only need use the
tools appropriate for your data.

```{r getting_viral_set_1}
getting_viral_set_1 <- function(input_seqs,
                                include_vibrant=FALSE, 
                                include_virsorter2=FALSE,
                                include_deepvirfinder=FALSE,
                                include_tuning_viral=FALSE,
                                include_tuning_not_viral=FALSE,
                                include_virsorter=FALSE) {
  
  keep_score <- rep(0, nrow(input_seqs))
  
  if (include_vibrant) {
    keep_score[input_seqs$vibrant_quality=="complete circular"] <- keep_score[input_seqs$vibrant_quality=="complete circular"] + 1
    keep_score[input_seqs$vibrant_quality=="high quality draft"] <- keep_score[input_seqs$vibrant_quality=="high quality draft"] + 1
    keep_score[input_seqs$vibrant_quality=="medium quality draft"] <- keep_score[input_seqs$vibrant_quality=="medium quality draft"] + 1
    keep_score[input_seqs$vibrant_quality=="low quality draft" & input_seqs$provirus] <- keep_score[input_seqs$vibrant_quality=="low quality draft" & input_seqs$provirus] + 0.5
  }
  
  if (include_virsorter2) {
    keep_score[input_seqs$viral>=50] <- keep_score[input_seqs$viral>=50] + 0.5
    keep_score[input_seqs$viral>=95] <- keep_score[input_seqs$viral>=95] + 0.5
    keep_score[input_seqs$RNA>=0.9] <- keep_score[input_seqs$RNA>=0.9] + 1
    keep_score[input_seqs$lavidaviridae>=0.9] <- keep_score[input_seqs$lavidaviridae>=0.9] + 1
    keep_score[input_seqs$NCLDV>=0.9] <- keep_score[input_seqs$NCLDV>=0.9] + 1
  }
  
  if (include_virsorter) {
    keep_score[input_seqs$category==1] <- keep_score[input_seqs$category==1] + 1
    keep_score[input_seqs$category==2] <- keep_score[input_seqs$category==2] + 0.5
    keep_score[input_seqs$category==4] <- keep_score[input_seqs$category==4] + 1
    keep_score[input_seqs$category==5] <- keep_score[input_seqs$category==5] + 0.5
  }
  
  if (include_deepvirfinder) {
    keep_score[input_seqs$score>=0.7 & input_seqs$checkv_length<20000] <- keep_score[input_seqs$score>=0.7 & input_seqs$checkv_length<20000] + 0.5
    keep_score[input_seqs$score>=0.9 & input_seqs$checkv_length<20000] <- keep_score[input_seqs$score>=0.9 & input_seqs$checkv_length<20000] + 0.5
  }
  
  if (include_tuning_viral) {
    keep_score[input_seqs$Kaiju_Viral=="Viruses"] <- keep_score[input_seqs$Kaiju_Viral=="Viruses"] + 0.5
    keep_score[input_seqs$hallmark>2] <- keep_score[input_seqs$hallmark>2] + 1
    keep_score[input_seqs$percent_unknown>=75 & input_seqs$checkv_length<50000] <- keep_score[input_seqs$percent_unknown>=75 & input_seqs$checkv_length<50000] + 0.5
    keep_score[input_seqs$percent_viral>=50] <- keep_score[input_seqs$percent_viral>=50] + 0.5
  }
  
  if (include_tuning_not_viral) {
    keep_score[input_seqs$Kaiju_Viral=="cellular organisms"] <- keep_score[input_seqs$Kaiju_Viral=="cellular organisms"] - 0.5
    keep_score[input_seqs$checkv_host_genes>50 & !input_seqs$provirus] <- keep_score[input_seqs$checkv_host_genes>50 & !input_seqs$provirus] - 1
    keep_score[input_seqs$checkv_viral_genes==0 & input_seqs$checkv_host_genes>=1] <- keep_score[input_seqs$checkv_viral_genes==0 & input_seqs$checkv_host_genes>=1] - 1
    keep_score[((input_seqs$checkv_viral_genes*3) <= input_seqs$checkv_host_genes) & !input_seqs$provirus] <- keep_score[((input_seqs$checkv_viral_genes*3) <= input_seqs$checkv_host_genes) & !input_seqs$provirus] - 1 # consider accounting for RNA viruses
    keep_score[input_seqs$checkv_length>500000 & input_seqs$hallmark<=1] <- keep_score[input_seqs$checkv_length>500000 & input_seqs$hallmark<=1] - 1
    keep_score[input_seqs$checkv_completeness<=75 & input_seqs$checkv_length<=5000] <- keep_score[input_seqs$checkv_completeness<=75 & input_seqs$checkv_length<=5000] - 0.5 # helped with protist contamination
  }
  
  return(keep_score)
  
}
```

# Comparing all of the tool methods

```{r}
combos_list <- data.frame(toolcombo=rep(0, 64),
                          tune_not_viral=rep(0, 64),
                          DVF=rep(0, 64),
                          tune_viral=rep(0, 64),
                          VIBRANT=rep(0, 64),
                          VS=rep(0, 64),
                          VS2=rep(0, 64))
p <- 1

for (i in c(0,1)){
  for (j in c(0,1)){
    for (k in c(0,1)){
      for (l in c(0,1)){
        for (m in c(0,1)){
          for (n in c(0,1)){
            combos_list$toolcombo[p] <- paste(i,j,k,l,m,n)
            combos_list$toolcombo2[p] <- paste(if(i){"tnv"}else{"0"},if(j){"DVF"}else{"0"},
                                               if(k){"tv"}else{"0"},if(l){"VB"}else{"0"},
                                               if(m){"VS"}else{"0"},if(n){"VS2"}else{"0"})
            combos_list$tune_not_viral[p] <- i
            combos_list$DVF[p] <- j
            combos_list$tune_viral[p] <- k
            combos_list$VIBRANT[p] <- l
            combos_list$VS[p] <- m
            combos_list$VS2[p] <- n
            p <- p+1
          }
        }
      }
    }
  }
}

combos_list <- combos_list[-1,]
```

```{r}
viral_scores <- matrix(data=0, nrow=nrow(viruses), ncol=nrow(combos_list))
num_viruses <- data.frame(toolcombo=rep(0, nrow(combos_list)),
                          num_viruses=rep(0, nrow(combos_list)))
for (i in 1:nrow(combos_list)) {
  viral_scores[,i] <- getting_viral_set_1(viruses, include_vibrant = combos_list$VIBRANT[i],
                                            include_virsorter = combos_list$VS[i],
                                            include_virsorter2 = combos_list$VS2[i],
                                            include_tuning_viral = combos_list$tune_viral[i],
                                            include_tuning_not_viral = combos_list$tune_not_viral[i],
                                            include_deepvirfinder = combos_list$DVF[i])
  
  if (max(viral_scores[,i])<=0) {
    num_viruses$num_viruses[i] <- 0
  }
  else {
    num_viruses$num_viruses[i] <- table(viral_scores[,i]>=1)[[2]]
  }
  num_viruses$toolcombo[i] <- combos_list$toolcombo[i]
  
  num_viruses$toolcombo2[i] <- combos_list$toolcombo2[i]
}
num_viruses$numtools <- str_count(num_viruses$toolcombo, "1")
num_viruses <- num_viruses[order(num_viruses$num_viruses, decreasing=F),]
num_viruses$toolcombo <- factor(num_viruses$toolcombo, levels = unique(num_viruses$toolcombo))
num_viruses$toolcombo2 <- factor(num_viruses$toolcombo2, levels = unique(num_viruses$toolcombo2))
num_viruses$numtools <- as.factor(num_viruses$numtools)
```

```{r}
dim(viral_scores)
```

##matrix of number in agreement between tools
### number predicted together
```{r}
num_high_viruses <- matrix(data=NA, nrow=63, ncol=63)

for (i in 1:63) {
  for (j in 1:63) {
    num_high_viruses[i,j] <- sum(viral_scores[,i]>=1 & viral_scores[,j]>=1)
  }
}

rownames(num_high_viruses) <- combos_list$toolcombo
colnames(num_high_viruses) <- combos_list$toolcombo

prop_high_viruses <- matrix(data=NA, nrow=63, ncol=63)

for (i in 1:63) {
  for (j in 1:63) {
    prop_high_viruses[i,j] <- sum(viral_scores[,i]>=1 & viral_scores[,j]>=1)
    prop_high_viruses[i,j] <- prop_high_viruses[i,j]/sum(viral_scores[,i]>=1 | viral_scores[,j]>=1)
  }
}

rownames(prop_high_viruses) <- combos_list$toolcombo
colnames(prop_high_viruses) <- combos_list$toolcombo
```

```{r}
pal <- ggthemes::tableau_color_pal(palette="Tableau 10", type="regular")

ann_col = data.frame(
    tnv = combos_list$tune_not_viral,
    tv = combos_list$tune_viral,
    dvf = combos_list$DVF,
    vb = combos_list$VIBRANT,
    vs = combos_list$VS,
    vs2 = combos_list$VS2,
    num_vir = colSums(viral_scores>=1)+1
)

ann_colors = list(
  num_vir=magma(100),
  tnv = c("black", pal(6)[1]),
  tv = c("black", pal(6)[3]),
  dvf = c("black", pal(6)[2]),
  vb = c("black", pal(6)[4]),
  vs = c("black", pal(6)[5]),
  vs2 = c("black", pal(6)[6])
)

rownames(ann_col) <- combos_list$toolcombo

pheatmap::pheatmap(num_high_viruses,
                  annotation_row = ann_col,
                  annotation_colors = ann_colors,
                  border_color = "black",
                  color = magma(100),
                  cutree_rows = 4,
                  cutree_cols = 4,
                  show_rownames = F,
                  filename = "../IntermediaryFiles/pheatmap_num_viruses_in_common.png",
                  annotation_legend = F)
```

```{r}
pal <- ggthemes::tableau_color_pal(palette="Tableau 10", type="regular")

ann_col = data.frame(
    tnv = combos_list$tune_not_viral,
    tv = combos_list$tune_viral,
    dvf = combos_list$DVF,
    vb = combos_list$VIBRANT,
    vs = combos_list$VS,
    vs2 = combos_list$VS2,
    num_vir = colSums(viral_scores>=1)+1
)

ann_colors = list(
  num_vir=magma(100),
  tnv = c("black", pal(6)[1]),
  tv = c("black", pal(6)[3]),
  dvf = c("black", pal(6)[2]),
  vb = c("black", pal(6)[4]),
  vs = c("black", pal(6)[5]),
  vs2 = c("black", pal(6)[6])
)

rownames(ann_col) <- combos_list$toolcombo

pheatmap::pheatmap(prop_high_viruses,
                  annotation_row = ann_col,
                  annotation_colors = ann_colors,
                  border_color = "black",
                  color = viridis(100),
                  cutree_rows = 4,
                  cutree_cols = 4,
                  show_rownames = F,
                  filename = "../IntermediaryFiles/pheatmap_prop_viruses_in_common.png",
                  annotation_legend = F)
```

```{r}
prop_high_viruses_long <- as.data.frame(prop_high_viruses)
prop_high_viruses_long$tool <- combos_list$toolcombo

prop_high_viruses_long <- as.data.frame(prop_high_viruses_long) %>% 
  pivot_longer(!tool,
               values_to="proportion",
               names_to="tool2") 

prop_high_viruses_long$binned_prop <- "0-10%"
prop_high_viruses_long$binned_prop[prop_high_viruses_long$proportion>=0.10] <- "10-50%"
prop_high_viruses_long$binned_prop[prop_high_viruses_long$proportion>=0.50] <- "50-90%"
prop_high_viruses_long$binned_prop[prop_high_viruses_long$proportion>=0.90] <- "90-100%"


```

```{r}
table(prop_high_viruses_long$binned_prop)
```

```{r}
prop_high_viruses_long$toolcombo <- paste(prop_high_viruses_long$tool,
                                          prop_high_viruses_long$tool2,
                                          sep="-")
prop_high_viruses_long$toolcombo <- gsub(" ", "", prop_high_viruses_long$toolcombo)
prop_high_viruses_long$toolcombo <- unique(prop_high_viruses_long$toolcombo)
```


```{r}
head(prop_high_viruses_long)
```


```{r}
hist(prop_high_viruses_long$proportion,
     )
```

# numbers in common between two tool combos
```{r}
combos_list_two <- combos_list
combos_list_two$numtools <- str_count(combos_list_two$toolcombo, "1")
combos_list_two <- combos_list_two[combos_list_two$numtools==1,]

two_tool_pairs <- num_high_viruses[rownames(num_high_viruses) %in% combos_list_two$toolcombo,
                                   colnames(num_high_viruses) %in% combos_list_two$toolcombo]

colnames(two_tool_pairs) <- c("VS2", "VS", "VB", "tv", "DVF", "tnv")
rownames(two_tool_pairs) <- c("VS2", "VS", "VB", "tv", "DVF", "tnv")
```

```{r}
viral_scores_two <- viral_scores[,colnames(num_high_viruses) %in% combos_list_two$toolcombo]

n <- 6
viral_scores_two_comb <- matrix(data=NA, nrow=n, ncol=n)

for (i in 1:n) {
  for (j in 1:n) {
    if (i==j) {
      viral_scores_two_comb[i,j] <- sum(viral_scores_two[,i]>=1)
    }
    else if (i<j) {
      viral_scores_two_comb[i,j] <- sum((viral_scores_two[,i]+viral_scores_two[,j])>=1)
    }
    else if (i>j) {
      viral_scores_two_comb[i,j] <- paste(round(sum((viral_scores_two[,i]+viral_scores_two[,j])>=1)/sum(viral_scores_two[,i]>=1 | viral_scores_two[,j]>=1)*100, digits=0), "%", sep="")
    }
  }
}

colnames(viral_scores_two_comb) <- c("VS2", "VS", "VB", "tv", "DVF", "tnv")
rownames(viral_scores_two_comb) <- c("VS2", "VS", "VB", "tv", "DVF", "tnv")
```










