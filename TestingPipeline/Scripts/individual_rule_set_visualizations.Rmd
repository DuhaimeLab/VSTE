---
title: "Individual Rule Visualizations"
output: html_notebook
---

This is a notebook to look more at each rule set.

```{r setup-library}
library(ggplot2)
library(plyr)
library(reshape2)
library(viridis)
library(tidyr)
library(dplyr)
library(readr)
library(data.table)
library(pROC)
library("stringr")
```

Import the file that combines the results from each of the tools from running "combining_tool_output.Rmd":
```{r}
viruses <- read_tsv("../IntermediaryFiles/viral_tools_combined.tsv")
```

# Looking at each rule

```{r}
#viruses2 <- viruses
#viruses <- viruses[viruses$checkv_length<=10000,]
```

```{r}
#viruses <- viruses2
```


## VIBRANT
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(0, nrow(viruses)))

#vscore$vscore[viruses$vibrant_quality=="high quality draft"] <- vscore$vscore[viruses$vibrant_quality=="high quality draft"] + 1
#vscore$vscore[viruses$vibrant_quality=="medium quality draft"] <- vscore$vscore[viruses$vibrant_quality=="medium quality draft"] + 1
vscore$vscore[viruses$vibrant_quality=="low quality draft" & viruses$provirus] <- vscore$vscore[viruses$vibrant_quality=="low quality draft" & viruses$provirus] + 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```

## VirSorter2
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(0, nrow(viruses)))

vscore$vscore[viruses$max_score>=0.5] <- vscore$vscore[viruses$max_score>=0.5] + 0.5
vscore$vscore[viruses$max_score>=0.95] <- vscore$vscore[viruses$max_score>=0.95] + 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```

## VirSorter
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(0, nrow(viruses)))

vscore$vscore[viruses$category==1] <- vscore$vscore[viruses$category==1] + 1
vscore$vscore[viruses$category==2] <- vscore$vscore[viruses$category==2] + 0.5
vscore$vscore[viruses$category==4] <- vscore$vscore[viruses$category==4] + 1
vscore$vscore[viruses$category==5] <- vscore$vscore[viruses$category==5] + 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```

## DeepVirFinder
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(0, nrow(viruses)))

#vscore$vscore[viruses$score>=0.7 & viruses$checkv_length<20000] <- vscore$vscore[viruses$score>=0.7 & viruses$checkv_length<20000] + 0.5
#vscore$vscore[viruses$score>=0.9 & viruses$checkv_length<20000] <- vscore$vscore[viruses$score>=0.9 & viruses$checkv_length<20000] + 0.5
vscore$vscore[viruses$score>=0.9] <- vscore$vscore[viruses$score>=0.9] + 0.5
vscore$vscore[viruses$score>=0.7] <- vscore$vscore[viruses$score>=0.7] + 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```
## DVF for removal
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(1, nrow(viruses)))

vscore$vscore[viruses$score<=0.9] <- vscore$vscore[viruses$score<=0.9] - 0.5
vscore$vscore[viruses$score<=0.7] <- vscore$vscore[viruses$score<=0.7] - 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```


## Tuning Addition
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(0, nrow(viruses)))

vscore$vscore[viruses$Kaiju_Viral=="Viruses"] <- vscore$vscore[viruses$Kaiju_Viral=="Viruses"] + 0.5
vscore$vscore[viruses$hallmark>2] <- vscore$vscore[viruses$hallmark>2] + 0.5
vscore$vscore[viruses$percent_unknown>=75 & viruses$checkv_length<50000] <- vscore$vscore[viruses$percent_unknown>=75 & viruses$checkv_length<50000] + 0.5
vscore$vscore[viruses$viral>=50] <- vscore$vscore[viruses$viral>=50] + 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```

## Tuning Addition
by sub rule
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(0, nrow(viruses)))

vscore$vscore[viruses$Kaiju_Viral=="Viruses"] <- vscore$vscore[viruses$Kaiju_Viral=="Viruses"] + 0.25
vscore$vscore[viruses$hallmark>2] <- vscore$vscore[viruses$hallmark>2] + 0.5
vscore$vscore[viruses$percent_unknown>=75 & viruses$checkv_length<50000] <- vscore$vscore[viruses$percent_unknown>=75 & viruses$checkv_length<50000] + 0.5
vscore$vscore[viruses$viral>=50] <- vscore$vscore[viruses$viral>=50] + 0.25

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```

notes: hallmark+vs2 % viral: no archael, fungal, protists wrong
- hallmark+length based percent unknown: no archaea, bacteria, fungi, protists wrong
- vs2 % viral+length based percent unknown: no fungi wrong


## Tuning Removal
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(1, nrow(viruses)))

#vscore$vscore[viruses$Kaiju_Viral=="cellular organisms"] <- vscore$vscore[viruses$Kaiju_Viral=="cellular organisms"] - 0.5
vscore$vscore[viruses$checkv_host_genes>50 & !viruses$provirus] <- vscore$vscore[viruses$checkv_host_genes>50 & !viruses$provirus] - 1
vscore$vscore[viruses$checkv_viral_genes==0 & viruses$checkv_host_genes>=1] <- vscore$vscore[viruses$checkv_viral_genes==0 & viruses$checkv_host_genes>=1] - 1
vscore$vscore[((viruses$checkv_viral_genes*3) <= viruses$checkv_host_genes) & !viruses$provirus] <- vscore$vscore[((viruses$checkv_viral_genes*3) <= viruses$checkv_host_genes) & !viruses$provirus] - 1 
vscore$vscore[viruses$checkv_length>500000 & viruses$hallmark<=1] <- vscore$vscore[viruses$checkv_length>500000 & viruses$hallmark<=1] - 1
vscore$vscore[(viruses$checkv_completeness<=75 | viruses$vibrant_quality=="complete circular")& viruses$checkv_length<=5000] <- vscore$vscore[viruses$checkv_completeness<=75 & viruses$checkv_length<=5000] - 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```

## Tuning Removal by rule
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(1, nrow(viruses)))

#vscore$vscore[viruses$Kaiju_Viral=="cellular organisms"] <- vscore$vscore[viruses$Kaiju_Viral=="cellular organisms"] - 0.5
vscore$vscore[viruses$checkv_host_genes>50 & !viruses$provirus] <- 0
vscore$vscore[viruses$checkv_viral_genes==0 & viruses$checkv_host_genes>=1] <- vscore$vscore[viruses$checkv_viral_genes==0 & viruses$checkv_host_genes>=1] - 1 # maybe make 0
vscore$vscore[((viruses$checkv_viral_genes*3) <= viruses$checkv_host_genes) & !viruses$provirus] <- vscore$vscore[((viruses$checkv_viral_genes*3) <= viruses$checkv_host_genes) & !viruses$provirus] - 1 # maybe make 0
vscore$vscore[viruses$checkv_length>500000 & viruses$hallmark<=1] <- 0
vscore$vscore[(viruses$checkv_completeness<=75 | viruses$vibrant_quality=="complete circular")& viruses$checkv_length<=5000] <- vscore$vscore[viruses$checkv_completeness<=75 & viruses$checkv_length<=5000] - 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.4f")
```
comparing each tool's score
```{r}
viruses$keep_score_ind_vs2 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_ind_tv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_ind_dvf <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_ind_vb <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = T,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_ind_ntv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$keep_score_ind_vs <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = T)

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_ind_"), seqtype) %>%
  pivot_longer(cols=contains("keep_score_"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, seqtype) %>%
  summarise(n = n())
```

```{r}
pal_purple <- RColorBrewer::brewer.pal(4, "Purples")
pal_orange <- RColorBrewer::brewer.pal(3, "Oranges")

ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_manual(name="",
                     values = alpha(c(rev(pal_orange), pal_purple), 0.8)) +
  xlab("") +
  ylab("Number of Sequences") + 
  facet_grid(~seqtype, scales = "free")
```

