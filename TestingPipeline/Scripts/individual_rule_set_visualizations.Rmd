---
title: "Individual Rule Visualizations"
output: html_notebook
---

This is a notebook to look more at each rule set.

```{r setup-library}
library(ggplot2)
library(plyr)
library(reshape2)
library(viridis)
library(tidyr)
library(dplyr)
library(readr)
library(data.table)
library(pROC)
library("stringr")
```

Import the file that combines the results from each of the tools from running "combining_tool_output.Rmd":
```{r}
viruses <- read_tsv("../IntermediaryFiles/viral_tools_combined.tsv")
```

# Looking at each rule

```{r}
#viruses2 <- viruses
#viruses <- viruses[viruses$checkv_length<=10000,]
```

```{r}
#viruses <- viruses2
```


## VIBRANT
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(0, nrow(viruses)))

#vscore$vscore[viruses$vibrant_quality=="high quality draft"] <- vscore$vscore[viruses$vibrant_quality=="high quality draft"] + 1
#vscore$vscore[viruses$vibrant_quality=="medium quality draft"] <- vscore$vscore[viruses$vibrant_quality=="medium quality draft"] + 1
vscore$vscore[viruses$vibrant_quality=="low quality draft" & viruses$provirus] <- vscore$vscore[viruses$vibrant_quality=="low quality draft" & viruses$provirus] + 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```

## VirSorter2
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(0, nrow(viruses)))

vscore$vscore[viruses$max_score>=0.5] <- vscore$vscore[viruses$max_score>=0.5] + 0.5
vscore$vscore[viruses$max_score>=0.95] <- vscore$vscore[viruses$max_score>=0.95] + 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```

## VirSorter
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(0, nrow(viruses)))

vscore$vscore[viruses$category==1] <- vscore$vscore[viruses$category==1] + 1
vscore$vscore[viruses$category==2] <- vscore$vscore[viruses$category==2] + 0.5
vscore$vscore[viruses$category==4] <- vscore$vscore[viruses$category==4] + 1
vscore$vscore[viruses$category==5] <- vscore$vscore[viruses$category==5] + 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```

## DeepVirFinder
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(0, nrow(viruses)))

#vscore$vscore[viruses$score>=0.7 & viruses$checkv_length<20000] <- vscore$vscore[viruses$score>=0.7 & viruses$checkv_length<20000] + 0.5
#vscore$vscore[viruses$score>=0.9 & viruses$checkv_length<20000] <- vscore$vscore[viruses$score>=0.9 & viruses$checkv_length<20000] + 0.5
vscore$vscore[viruses$score>=0.9] <- vscore$vscore[viruses$score>=0.9] + 0.5
vscore$vscore[viruses$score>=0.7] <- vscore$vscore[viruses$score>=0.7] + 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```
## DVF for removal
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(1, nrow(viruses)))

vscore$vscore[viruses$score<=0.9] <- vscore$vscore[viruses$score<=0.9] - 0.5
vscore$vscore[viruses$score<=0.7] <- vscore$vscore[viruses$score<=0.7] - 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```


## Tuning Addition
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(0, nrow(viruses)))

vscore$vscore[viruses$Kaiju_Viral=="Viruses"] <- vscore$vscore[viruses$Kaiju_Viral=="Viruses"] + 0.5
vscore$vscore[viruses$hallmark>2] <- vscore$vscore[viruses$hallmark>2] + 0.5
vscore$vscore[viruses$percent_unknown>=75 & viruses$checkv_length<50000] <- vscore$vscore[viruses$percent_unknown>=75 & viruses$checkv_length<50000] + 0.5
vscore$vscore[viruses$viral>=50] <- vscore$vscore[viruses$viral>=50] + 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```

## Tuning Addition
by sub rule
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(0, nrow(viruses)))

vscore$vscore[viruses$Kaiju_Viral=="Viruses"] <- vscore$vscore[viruses$Kaiju_Viral=="Viruses"] + 0.25
vscore$vscore[viruses$hallmark>2] <- vscore$vscore[viruses$hallmark>2] + 0.5
vscore$vscore[viruses$percent_unknown>=75 & viruses$checkv_length<50000] <- vscore$vscore[viruses$percent_unknown>=75 & viruses$checkv_length<50000] + 0.5
vscore$vscore[viruses$viral>=50] <- vscore$vscore[viruses$viral>=50] + 0.25

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```

notes: hallmark+vs2 % viral: no archael, fungal, protists wrong
- hallmark+length based percent unknown: no archaea, bacteria, fungi, protists wrong
- vs2 % viral+length based percent unknown: no fungi wrong


## Tuning Removal
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(1, nrow(viruses)))

#vscore$vscore[viruses$Kaiju_Viral=="cellular organisms"] <- vscore$vscore[viruses$Kaiju_Viral=="cellular organisms"] - 0.5
vscore$vscore[viruses$checkv_host_genes>50 & !viruses$provirus] <- vscore$vscore[viruses$checkv_host_genes>50 & !viruses$provirus] - 1
vscore$vscore[viruses$checkv_viral_genes==0 & viruses$checkv_host_genes>=1] <- vscore$vscore[viruses$checkv_viral_genes==0 & viruses$checkv_host_genes>=1] - 1
vscore$vscore[((viruses$checkv_viral_genes*3) <= viruses$checkv_host_genes) & !viruses$provirus] <- vscore$vscore[((viruses$checkv_viral_genes*3) <= viruses$checkv_host_genes) & !viruses$provirus] - 1 
vscore$vscore[viruses$checkv_length>500000 & viruses$hallmark<=1] <- vscore$vscore[viruses$checkv_length>500000 & viruses$hallmark<=1] - 1
vscore$vscore[(viruses$checkv_completeness<=75 | viruses$vibrant_quality=="complete circular")& viruses$checkv_length<=5000] <- vscore$vscore[viruses$checkv_completeness<=75 & viruses$checkv_length<=5000] - 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.3f")
```

## Tuning Removal by rule
```{r}
vscore <- tibble(seqtype=viruses$seqtype,
                 vscore=rep(1, nrow(viruses)))

#vscore$vscore[viruses$Kaiju_Viral=="cellular organisms"] <- vscore$vscore[viruses$Kaiju_Viral=="cellular organisms"] - 0.5
vscore$vscore[viruses$checkv_host_genes>50 & !viruses$provirus] <- 0
vscore$vscore[viruses$checkv_viral_genes==0 & viruses$checkv_host_genes>=1] <- vscore$vscore[viruses$checkv_viral_genes==0 & viruses$checkv_host_genes>=1] - 1 # maybe make 0
vscore$vscore[((viruses$checkv_viral_genes*3) <= viruses$checkv_host_genes) & !viruses$provirus] <- vscore$vscore[((viruses$checkv_viral_genes*3) <= viruses$checkv_host_genes) & !viruses$provirus] - 1 # maybe make 0
vscore$vscore[viruses$checkv_length>500000 & viruses$hallmark<=1] <- 0
vscore$vscore[(viruses$checkv_completeness<=75 | viruses$vibrant_quality=="complete circular")& viruses$checkv_length<=5000] <- vscore$vscore[viruses$checkv_completeness<=75 & viruses$checkv_length<=5000] - 0.5

vscore$confusion_matrix <- "correct"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore<1] <- "false"
vscore$confusion_matrix[vscore$seqtype=="virus" & vscore$vscore>=1] <- "correct"
vscore$confusion_matrix[vscore$seqtype!="virus" & vscore$vscore>=1] <- "false"

table(vscore$seqtype, vscore$confusion_matrix)

pheatmap::pheatmap(table(vscore$seqtype, vscore$confusion_matrix)/c(rowSums(table(vscore$seqtype, vscore$confusion_matrix))),
                   color=c("black", viridis(1000)),
                   cluster_rows = F,
                   cluster_cols = F,
                   display_numbers = T,
                   number_color = "white", 
                   fontsize_number = 10,
                   number_format = "%.4f")
```
comparing each tool's score
```{r}
viruses$keep_score_ind_vs2 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_ind_tv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_ind_dvf <- getting_viral_set_1(viruses, include_deepvirfinder = T,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_ind_vb <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = T,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_ind_ntv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$keep_score_ind_vs <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = T)

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_ind_"), seqtype) %>%
  pivot_longer(cols=contains("keep_score_"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, seqtype) %>%
  summarise(n = n())

viruses_long_scores$rule_type <- "viral identification tool-based"
viruses_long_scores$rule_type[viruses_long_scores$rule_combination=="keep_score_ind_tv"] <- "tuning"
viruses_long_scores$rule_type[viruses_long_scores$rule_combination=="keep_score_ind_ntv"] <- "tuning"

```

```{r}

viruses_long_scores$seqtype <- factor(viruses_long_scores$seqtype, levels = c("virus", "bacteria", "archaea", "plasmid", "protist", "fungi"))

#viruses_long_scores$rule_combination <- factor(viruses_long_scores$rule_combination, 
#                                               levels = c(rev("keep_score_ind_vs2", "keep_score_ind_vs",
#                                                              "keep_score_ind_vb", "keep_score_ind_dvf"),
#                                                         rev("keep_score_ind_tv", "keep_score_ind_ntv")))

viruses_long_scores$rule_type <- factor(viruses_long_scores$rule_type, levels = c("viral identification tool-based", "tuning"))

pal_purple <- RColorBrewer::brewer.pal(4, "Purples")
pal_orange <- RColorBrewer::brewer.pal(4, "Oranges")

fig <- ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom",
    strip.background = element_rect(fill="white", color="grey"),
    strip.text = element_text(color="black")
  ) +
  scale_fill_manual(name="Viral Score",
                     values = alpha(c(rev(RColorBrewer::brewer.pal(9,"Oranges")[4:7]),
                            RColorBrewer::brewer.pal(9,"Purples")[4:9] 
                            ), 0.8)) +
  xlab("Ruleset") +
  ylab("Proportion") + 
  facet_grid(rule_type~seqtype, scales = "free") 

fig

ggsave(
  "../IntermediaryFiles/individual_tool_rulesets.png",
  plot = fig,
  scale = 1,
  width = 8,
  height = 4,
  units = c("in"),
  dpi = 300,
  limitsize = TRUE
)
```


making a smaller test set of rules
Function that allows for the comparing pieces of the pipeline
```{r getting_viral_set_1}
getting_viral_set_mod <- function(input_seqs,
                                include_vibrant=FALSE, 
                                include_virsorter2=FALSE,
                                include_deepvirfinder=FALSE,
                                include_tuning_viral=FALSE,
                                tv_1=T, tv_2=T, tv_3=T, tv_4=T,
                                include_tuning_not_viral=FALSE,
                                ntv_1=T, ntv_2=T, ntv_3=T, ntv_4=T, ntv_5=T,
                                include_virsorter=FALSE) {
  
  keep_score <- rep(0, nrow(input_seqs))

  if (include_vibrant) {
    keep_score[input_seqs$vibrant_quality=="high quality draft"] <- keep_score[input_seqs$vibrant_quality=="high quality draft"] + 1
    keep_score[input_seqs$vibrant_quality=="medium quality draft"] <- keep_score[input_seqs$vibrant_quality=="medium quality draft"] + 1
    keep_score[input_seqs$vibrant_quality=="low quality draft" & input_seqs$provirus] <- keep_score[input_seqs$vibrant_quality=="low quality draft" & input_seqs$provirus] + 0.5
  }
  
  if (include_virsorter2) {
    keep_score[input_seqs$max_score>=0.50] <- keep_score[input_seqs$max_score>=0.50] + 0.5
    keep_score[input_seqs$max_score>=0.95] <- keep_score[input_seqs$max_score>=0.95] + 0.5  
  }
  
  if (include_virsorter) {
    keep_score[input_seqs$category==1] <- keep_score[input_seqs$category==1] + 1
    keep_score[input_seqs$category==2] <- keep_score[input_seqs$category==2] + 0.5
    keep_score[input_seqs$category==3] <- keep_score[input_seqs$category==3] + 0.5
    keep_score[input_seqs$category==4] <- keep_score[input_seqs$category==4] + 1
    keep_score[input_seqs$category==5] <- keep_score[input_seqs$category==5] + 0.5 
    keep_score[input_seqs$category==6] <- keep_score[input_seqs$category==6] + 0.5 
  }
  
  if (include_deepvirfinder) {
     # add if DVF calls viral
    keep_score[(input_seqs$score>=0.9 & input_seqs$pvalue<=0.05) & input_seqs$checkv_length<20000] <- keep_score[(input_seqs$score>=0.9 & input_seqs$pvalue<=0.05) & input_seqs$checkv_length<20000] + 0.5
    keep_score[(input_seqs$score>=0.7 & input_seqs$pvalue<=0.05) & input_seqs$checkv_length<20000] <- keep_score[(input_seqs$score>=0.7 & input_seqs$pvalue<=0.05) & input_seqs$checkv_length<20000] + 0.5
  }
  
  if (include_tuning_viral) {
    keep_score <- tuning_viral(current_score=keep_score,
                               ins=input_seqs,
                         include_tv_1=tv_1,
                         include_tv_2=tv_2,
                         include_tv_3=tv_3,
                         include_tv_4=tv_4)
  }
  
  if (include_tuning_not_viral) {
    # tuning removal 
    keep_score <- tuning_not_viral(current_score=keep_score,
                               ins=input_seqs,
                         include_tv_1=ntv_1,
                         include_tv_2=ntv_2,
                         include_tv_3=ntv_3,
                         include_tv_4=ntv_4,
                         include_tv_5=ntv_5)
   
  }
  
  return(keep_score)
  
}

tuning_viral <- function(current_score, ins, 
                         include_tv_1=T,
                         include_tv_2=T,
                         include_tv_3=T,
                         include_tv_4=T) {
    # tuning addition
  if (include_tv_1) {
    current_score[ins$hallmark>2] <- current_score[ins$hallmark>2] + 1
  }
  if (include_tv_2) {
    current_score[ins$Kaiju_Viral=="Viruses" & ins$kaiju_match_ratio>=0.3] <- current_score[ins$Kaiju_Viral=="Viruses" & ins$kaiju_match_ratio>=0.3] + 1
  }
    #note: had tried pulling out this rule, but better recall without sacrificing precision with it in
    #note: having kaiju removal rule didn't help
  if (include_tv_3) {
    current_score[ins$percent_unknown>=75 & ins$checkv_length<50000] <- current_score[ins$percent_unknown>=75 & ins$checkv_length<50000] + 0.5
  }
  if (include_tv_4) {
    current_score[ins$viral>=50 | ins$percent_viral>=50] <- current_score[ins$viral>=50 | ins$percent_viral>=50] + 0.5 
  }
  return(current_score)
}

tuning_not_viral <- function(current_score, ins, 
                         include_tv_1=T,
                         include_tv_2=T,
                         include_tv_3=T,
                         include_tv_4=T,
                         include_tv_5=F) {
    # tuning removal
  if (include_tv_2) {
    current_score[ins$checkv_viral_genes==0 & ins$checkv_host_genes>=1] <- current_score[ins$checkv_viral_genes==0 & ins$checkv_host_genes>=1] - 1
  }
  if (include_tv_3) {
    current_score[((ins$checkv_viral_genes*3) <= ins$checkv_host_genes) & !ins$provirus] <- current_score[((ins$checkv_viral_genes*3) <= ins$checkv_host_genes) & !ins$provirus] - 1
  }
  
  if (include_tv_5) {
    # remove if DVF calls it not viral
    current_score[ins$score<=0.7 & ins$pvalue<=0.05] <- current_score[ins$score<=0.7 & ins$pvalue<=0.05] - 1 
  }
  
  if (include_tv_1) {
    current_score[(ins$checkv_host_genes>50) & !ins$provirus] <- -3
  }
  
  if (include_tv_4) {
    current_score[ins$checkv_length>500000 & ins$hallmark<=1] <- -3
  }
  
  return(current_score)
}
```

same idea but with a VS2 base
```{r}
viruses$keep_score_vs2 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=T, ntv_2=T, ntv_3=T, ntv_4=T, ntv_5=T,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_tv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=T, tv_2=T, tv_3=T, tv_4=T,
                                              include_tuning_not_viral = T,
                                              ntv_1=T, ntv_2=T, ntv_3=T, ntv_4=T, ntv_5=T,
                                              include_virsorter = F)

viruses$keep_score_vs2_tv <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=T, tv_2=T, tv_3=T, tv_4=T,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_1_2_3_4_tv_1_3_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=T, tv_2=F, tv_3=T, tv_4=T,
                                              include_tuning_not_viral = T,
                                              ntv_1=T, ntv_2=T, ntv_3=T, ntv_4=T, ntv_5=F,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_all_tv_1_3_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=T, tv_2=F, tv_3=T, tv_4=T,
                                              include_tuning_not_viral = T,
                                              ntv_1=T, ntv_2=T, ntv_3=T, ntv_4=T, ntv_5=T,
                                              include_virsorter = F)

viruses$keep_score_vs2_ntv_1_2_3_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=T, ntv_2=T, ntv_3=T, ntv_4=T, ntv_5=F,
                                              include_virsorter = F)

viruses$keep_score_vs2_tv_1_3_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = T,
                                              include_tuning_viral = T,
                                              tv_1=T, tv_2=F, tv_3=T, tv_4=T,
                                              include_tuning_not_viral = F,
                                              include_virsorter = F)

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_vs2"), seqtype) %>%
  pivot_longer(cols=contains("keep_score_vs2"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, seqtype) %>%
  summarise(n = n())

ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_manual(name="",
                     values = alpha(c(rev(pal_orange), pal_purple), 0.7)) +
  xlab("") +
  ylab("Number of Sequences") + 
  facet_grid(~seqtype, scales = "free")
```

```{r}
viruses$keep_score_ntv_1 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=T, ntv_2=F, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_virsorter = F)
viruses$keep_score_ntv_2 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=F, ntv_2=T, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_virsorter = F)
viruses$keep_score_ntv_3 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=F, ntv_2=F, ntv_3=T, ntv_4=F, ntv_5=F,
                                              include_virsorter = F)
viruses$keep_score_ntv_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=F, ntv_2=F, ntv_3=F, ntv_4=T, ntv_5=F,
                                              include_virsorter = F)
viruses$keep_score_ntv_5 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=F, ntv_2=F, ntv_3=F, ntv_4=F, ntv_5=T,
                                              include_virsorter = F)
viruses$keep_score_ntv_1_2 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=T, ntv_2=T, ntv_3=F, ntv_4=F, ntv_5=F,
                                              include_virsorter = F)
viruses$keep_score_ntv_1_3 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=T, ntv_2=F, ntv_3=T, ntv_4=F, ntv_5=F,
                                              include_virsorter = F)
viruses$keep_score_ntv_1_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=T, ntv_2=F, ntv_3=F, ntv_4=T, ntv_5=F,
                                              include_virsorter = F)
viruses$keep_score_ntv_1_5 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=T, ntv_2=F, ntv_3=F, ntv_4=F, ntv_5=T,
                                              include_virsorter = F)
viruses$keep_score_ntv_2_3 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=F, ntv_2=T, ntv_3=T, ntv_4=F, ntv_5=F,
                                              include_virsorter = F)
viruses$keep_score_ntv_2_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=F, ntv_2=T, ntv_3=F, ntv_4=T, ntv_5=F,
                                              include_virsorter = F)
viruses$keep_score_ntv_2_5 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=F, ntv_2=T, ntv_3=F, ntv_4=F, ntv_5=T,
                                              include_virsorter = F)
viruses$keep_score_ntv_3_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=F, ntv_2=F, ntv_3=T, ntv_4=T, ntv_5=F,
                                              include_virsorter = F)
viruses$keep_score_ntv_3_5 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=F, ntv_2=F, ntv_3=T, ntv_4=F, ntv_5=T,
                                              include_virsorter = F)
viruses$keep_score_ntv_4_5 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              ntv_1=F, ntv_2=F, ntv_3=F, ntv_4=T, ntv_5=T,
                                              include_virsorter = F)
viruses$keep_score_ntv_all <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                              include_vibrant = F,
                                              include_virsorter2 = F,
                                              include_tuning_viral = F,
                                              include_tuning_not_viral = T,
                                              include_virsorter = F)

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_ntv"), seqtype) %>%
  pivot_longer(cols=contains("keep_score_ntv"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, seqtype) %>%
  summarise(n = n())
ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_manual(name="",
                     values = alpha(c(rev(pal_orange), pal_purple), 0.7)) +
  xlab("") +
  ylab("Number of Sequences") + 
  facet_grid(~seqtype, scales = "free")
```

```{r}
viruses$keep_score_tv_1 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                             include_vibrant = F,
                                             include_virsorter2 = F,
                                             include_tuning_viral = T,
                                             tv_1=T, tv_2=F, tv_3=F, tv_4=F,
                                             include_tuning_not_viral = F,
                                             include_virsorter = F)
viruses$keep_score_tv_2 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                             include_vibrant = F,
                                             include_virsorter2 = F,
                                             include_tuning_viral = T,
                                             tv_1=F, tv_2=T, tv_3=F, tv_4=F,
                                             include_tuning_not_viral = F,
                                             include_virsorter = F)
viruses$keep_score_tv_3 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                             include_vibrant = F,
                                             include_virsorter2 = F,
                                             include_tuning_viral = T,
                                             tv_1=F, tv_2=F, tv_3=T, tv_4=F,
                                             include_tuning_not_viral = F,
                                             include_virsorter = F)
viruses$keep_score_tv_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                             include_vibrant = F,
                                             include_virsorter2 = F,
                                             include_tuning_viral = T,
                                             tv_1=F, tv_2=F, tv_3=F, tv_4=T,
                                             include_tuning_not_viral = F,
                                             include_virsorter = F)
viruses$keep_score_tv_1_2 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                             include_vibrant = F,
                                             include_virsorter2 = F,
                                             include_tuning_viral = T,
                                             tv_1=T, tv_2=T, tv_3=F, tv_4=F,
                                             include_tuning_not_viral = F,
                                             include_virsorter = F)
viruses$keep_score_tv_1_3 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                             include_vibrant = F,
                                             include_virsorter2 = F,
                                             include_tuning_viral = T,
                                             tv_1=T, tv_2=F, tv_3=T, tv_4=F,
                                             include_tuning_not_viral = F,
                                             include_virsorter = F)
viruses$keep_score_tv_1_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                             include_vibrant = F,
                                             include_virsorter2 = F,
                                             include_tuning_viral = T,
                                             tv_1=T, tv_2=F, tv_3=F, tv_4=T,
                                             include_tuning_not_viral = F,
                                             include_virsorter = F)
viruses$keep_score_tv_2_3 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                             include_vibrant = F,
                                             include_virsorter2 = F,
                                             include_tuning_viral = T,
                                             tv_1=F, tv_2=T, tv_3=T, tv_4=F,
                                             include_tuning_not_viral = F,
                                             include_virsorter = F)
viruses$keep_score_tv_2_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                             include_vibrant = F,
                                             include_virsorter2 = F,
                                             include_tuning_viral = T,
                                             tv_1=F, tv_2=T, tv_3=F, tv_4=T,
                                             include_tuning_not_viral = F,
                                             include_virsorter = F)
viruses$keep_score_tv_3_4 <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                             include_vibrant = F,
                                             include_virsorter2 = F,
                                             include_tuning_viral = T,
                                             tv_1=F, tv_2=F, tv_3=T, tv_4=T,
                                             include_tuning_not_viral = F,
                                             include_virsorter = F)
viruses$keep_score_tv_all <- getting_viral_set_1(viruses, include_deepvirfinder = F,
                                             include_vibrant = F,
                                             include_virsorter2 = F,
                                             include_tuning_viral = T,
                                             include_tuning_not_viral = F,
                                             include_virsorter = F)

viruses$true_virus <- "not"
viruses$true_virus[viruses$seqtype=="virus"] <- "virus"

viruses_long_scores <- viruses %>% 
  select(contains("keep_score_tv"), seqtype) %>%
  pivot_longer(cols=contains("keep_score_tv"), 
               names_to="rule_combination",
               values_to="viral_score") %>% 
  mutate(viral_score=as.factor(round(viral_score))) %>%
  group_by(rule_combination, viral_score, seqtype) %>%
  summarise(n = n())
ggplot(viruses_long_scores, aes(y=n, x=rule_combination,
                   fill=viral_score)) +
  geom_bar(stat="identity", color="black") +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_fill_manual(name="",
                     values = alpha(c(pal_orange[1], pal_purple), 0.7)) +
  xlab("") +
  ylab("Number of Sequences") + 
  facet_grid(~seqtype, scales = "free")
```

