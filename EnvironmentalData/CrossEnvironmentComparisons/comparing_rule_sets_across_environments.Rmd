---
title: "Comparing rule sets across environments"
output: html_notebook
---

```{r setup-library}
library(ggplot2)
library(plyr)
library(reshape2)
library(viridis)
library(tidyr)
library(dplyr)
library(readr)
library(data.table)
```


```{r}
viruses_dw <- read_csv("../DrinkingWaterMetagenomes/drinking_water_num_viruses.csv")
```
```{r}
viruses_rest <- read_csv("/Users/hegartyb/Downloads/num_viruses_env.csv")
```

only keeping chlorinated drinking water samples
```{r}
viruses_dw <- viruses_dw[viruses_dw$assembly %in% c("Birmingham_Maria",
                                                       "Cardiff_Maria", "Dundee_Clat",
                                                       "Dundee_Maria",
                                                       "Exeter_Maria", "Glasgow_Bal",
                                                       "Glasgow_Mil", "London_Maria"),
                           ]
```

```{r}
viruses_dw$environment <- "drinking_water"

viruses_rest$environment[viruses_rest$environment=="waste_water"] <- "wastewater"
viruses_rest$environment[viruses_rest$environment=="lake_eerie"] <- "Lake_Erie"
viruses_rest$environment[viruses_rest$environment=="lake_michigan"] <- "Lake_Michigan"
viruses_rest$environment[viruses_rest$environment=="tara"] <- "global_oceans"

viruses_all <- rbind(viruses_dw, viruses_rest)
```

recoding AJ's samples to be able to separate virome from metagenome (and remove others)
```{r}
viruses_all$environment2 <- viruses_all$environment
viruses_all$environment2[viruses_all$assembly %in% c("49639", "49640", "49641", "49642")] <- "Lake_Erie_virome"
viruses_all$environment2[viruses_all$assembly %in% c("49613", "49614", "49618", "49621",
                                                     "49624", "49628", "49632", "49638")] <- "Lake_Erie_metagenome"
viruses_all <- viruses_all[viruses_all$environment2!="Lake_Erie",]
```




```{r}
viruses_all$environment2 <- factor(viruses_all$environment2,
                                    levels = c("drinking_water", "Lake_Erie_metagenome", 
                                               "global_oceans",
                                               "wastewater", "Lake_Erie_virome", 
                                               "Lake_Michigan"))
```


```{r}
viruses_all$best_coloring <- "others"
viruses_all$best_coloring[viruses_all$toolcombo=="1 1 1 1 1 1"] <- "all"
viruses_all$best_coloring[viruses_all$toolcombo=="0 1 1 1 1 1"] <- "high recall"
viruses_all$best_coloring[viruses_all$toolcombo=="1 0 1 1 1 1"] <- "high MCC"
viruses_all$best_coloring[viruses_all$toolcombo=="1 0 1 0 0 1"] <- "VS2 combo"
viruses_all$best_coloring[viruses_all$toolcombo=="1 1 0 1 0 0"] <- "high precision"
```


```{r}
ggplot(viruses_all, aes(x=toolcombo, y=prop_vir, 
                                  color=best_coloring, fill=best_coloring)) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Tool Combination (tnv, DVF, tv, VB, VS, VS2)") +
  ylab("Proportion of Contigs >3kb Viral") +
  scale_fill_manual(name="",
                     values = alpha(rev(viridis(6)), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(rev(viridis(6)), 0.7)) +
  facet_wrap(~environment2)
```

```{r}
viruses_all$type <- "metagenome"
viruses_all$type[viruses_all$environment2 %in% c("wastewater", "Lake_Erie_virome",
                                                 "Lake_Michigan")] <- "virome"
```



```{r}
ggplot(viruses_all[viruses_all$best_coloring %in% c("high MCC", "high recall"),], aes(x=environment2, y=prop_vir, 
                                  color=type, fill=type)) +
  geom_boxplot() +
  #geom_point() +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Environment") +
  ylab("Proportion of Contigs >3kb Viral") +
  scale_fill_manual(name="",
                     values = alpha(magma(4)[2:3], 0.3)) +
  scale_color_manual(name="",
                     values = alpha(magma(4)[2:3], 0.7)) +
  facet_wrap(~best_coloring)
```


```{r}
imp_toolcombs <- viruses_all %>% group_by(best_coloring, environment) %>%
  summarize(median=median(prop_vir),
            mean=mean(prop_vir),
            sd=sd(prop_vir)
            )
```

```{r}
ggplot(imp_toolcombs, aes(x=best_coloring, y=mean, 
                                  color=best_coloring, fill=best_coloring)) +
  geom_point(size=3) +
  theme_light() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.y=element_text(size=14),
    axis.text.x=element_text(size=14, angle = 90),
    legend.text=element_text(size=12),
    axis.title=element_text(size=16),
  ) +
  xlab("Tool Combination (tnv, DVF, tv, VB, VS, VS2)") +
  ylab("Proportion of Contigs >3kb Viral") +
  scale_fill_manual(name="",
                     values = alpha(rev(viridis(6)), 0.3)) +
  scale_color_manual(name="",
                     values = alpha(rev(viridis(6)), 0.7)) +
  facet_wrap(~environment)
```

```{r}
imp_toolcombs_wide <- viruses_all %>% group_by(best_coloring, environment) %>%
  summarize(median=median(prop_vir),
            mean=mean(prop_vir),
            sd=sd(prop_vir)
            ) %>%
  select(mean, environment, best_coloring) %>%
  pivot_wider(names_from=environment, values_from=mean)
```






